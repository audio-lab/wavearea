import"./chunk-A576P2ZR.js";var P=(s,t=e=>e!==void 0?": "+e:"")=>class extends Error{constructor(e){super(s(e)+t(e))}};var it=P(()=>"illegal argument(s)"),y=s=>{throw new it(s)};var rt=P(()=>"illegal state"),J=s=>{throw new rt(s)};var ot=Math.pow(2,32),q=class{constructor(t,e=0,i=t.length<<3){this.buffer=t,this.start=e,this.limit=i,this.seek(e)}*[Symbol.iterator](){let t=this.start,e=t>>>3,i=7-(t&7);for(;t<this.limit;)yield this.buffer[e]>>>i&1,--i<0&&(e++,i=7),t++}get length(){return this.limit}get position(){return this.bitPos}seek(t){return(t<this.start||t>=this.limit)&&y(`seek pos out of bounds: ${t}`),this.pos=t>>>3,this.bit=8-(t&7),this.bitPos=t,this}read(t=1){if(t>32)return this.read(t-32)*ot+this.read(32);if(t>8){let e=0,i=t&-8,r=t-i;for(r>0&&(e=this._read(r));i>0;)e=(e<<8|this._read(8))>>>0,i-=8;return e}else return this._read(t)}readFields(t){return t.map(e=>this.read(e))}readWords(t,e=8){let i=[];for(;t-- >0;)i.push(this.read(e));return i}readStruct(t){return t.reduce((e,[i,r])=>(e[i]=this.read(r),e),{})}readBit(){this.checkLimit(1),this.bit--,this.bitPos++;let t=this.buffer[this.pos]>>>this.bit&1;return this.bit===0&&(this.pos++,this.bit=8),t}_read(t){this.checkLimit(t);let e=this.bit-t,i;return e>=0?(this.bit=e,i=this.buffer[this.pos]>>>e&(1<<t)-1,e===0&&(this.pos++,this.bit=8)):(i=(this.buffer[this.pos++]&(1<<this.bit)-1)<<-e,this.bit=8+e,i=i|this.buffer[this.pos]>>>this.bit),this.bitPos+=t,i}checkLimit(t){this.bitPos+t>this.limit&&J("can't read past EOF")}};var nt=16,K=Math.pow(2,32),C=class{constructor(t,e=0){this.buffer=typeof t>"u"?new Uint8Array(nt):typeof t=="number"?new Uint8Array(t):t,this.start=e,this.seek(e),this.buffer[this.pos]&=~((1<<this.bit)-1)}get position(){return this.bitPos}seek(t){return(t<this.start||t>=this.buffer.length<<3)&&y(`seek pos out of bounds: ${t}`),this.pos=t>>>3,this.bit=8-(t&7),this.bitPos=t,this}bytes(){return this.buffer.slice(0,this.pos+(this.bit&7?1:0))}reader(t=0){return new q(this.buffer,t,this.position)}write(t,e=1){if(e>32){let i=Math.floor(t/K);this.write(i,e-32),this.write(t-i*K,32)}else if(e>8){let i=e&-8,r=e-i;for(r>0&&this._write(t>>>i,r),i-=8;i>=0;)this._write(t>>>i,8),i-=8}else this._write(t,e);return this}writeWords(t,e=8){let i=t[Symbol.iterator](),r;for(;r=i.next(),!r.done;)this.write(r.value,e)}writeBit(t){return this.bit--,this.buffer[this.pos]=this.buffer[this.pos]&~(1<<this.bit)|t<<this.bit,this.bit===0&&(this.ensureSize(),this.bit=8),this.bitPos++,this}_write(t,e){t&=(1<<e)-1;let i=this.buffer,r=this.pos,o=this.bit,a=o-e,c=o<8?~((1<<o)-1):0;return a>=0?(c|=(1<<a)-1,i[r]=i[r]&c|t<<a&~c,a===0?(this.ensureSize(),this.bit=8):this.bit=a):(this.bit=o=8+a,i[r]=i[r]&c|t>>>-a&~c,this.ensureSize(),this.buffer[this.pos]=this.buffer[this.pos]&(1<<o)-1|t<<o&255),this.bitPos+=e,this}ensureSize(){if(++this.pos===this.buffer.length){let t=new Uint8Array(this.buffer.length<<1);t.set(this.buffer),this.buffer=t}}};var V=(s,t)=>Math.floor(8+16*s+8*t*s);function E(s,t,e){return s<t?t:s>e?e:s}function S(s,t){let e=new Int16Array(s||4),i=new Int16Array(t||4);return{history:e,weights:i}}function U(s,t){return s[0]*t[0]+s[1]*t[1]+s[2]*t[2]+s[3]*t[3]>>13}function Z(s,t,e,i){let r=i>>4;s[0]+=t[0]<0?-r:r,s[1]+=t[1]<0?-r:r,s[2]+=t[2]<0?-r:r,s[3]+=t[3]<0?-r:r,t[0]=t[1],t[1]=t[2],t[2]=t[3],t[3]=e}var Y=s=>Math.sign(s)*Math.round(Math.abs(s)),$=Array(16).fill().map((s,t)=>Y(Math.pow(t+1,2.75))),lt=[.75,-.75,2.5,-2.5,4.5,-4.5,7,-7],B=$.map(s=>lt.map(t=>Y(t*s)));function at(s){if(s.read(32)!==1903124838)throw new Error("Not a QOA file; expected magic number 'qoaf'");let e={samples:s.read(32),channels:s.read(8),sampleRate:s.read(24)};return s.seek(64),e}function ct(s,t,e,i,r){let o=s.read(8),a=s.read(24),c=s.read(16),w=s.read(16),m=Math.floor(w-8-4*4*o),l=Math.floor(m/8)*20;if(o!=t.channels||a!=t.sampleRate||c*o>l)throw new Error("invalid frame header data");for(let n=0;n<o;n++){let h=e[n];for(let u=0;u<4;u++){let d=s.read(16);h.history[u]=d}for(let u=0;u<4;u++){let d=s.read(16);h.weights[u]=d}}for(let n=0;n<c;n+=20)for(let h=0;h<o;h++){let u=s.read(4),d=B[u],x=n,Q=Math.min(n+20,c)-x,N=e[h],f=i[h],b=r+x,R=N.weights,I=N.history,A=60;for(let F=0;F<Q;F++){let k=U(R,I),p=s.read(3),O=d[p],L=E(k+O,-32768,32767),T=L<0?L/32768:L/32767;f[b++]=T,Z(R,I,L,O),A-=3}A>0&&s.read(A)}return c}function tt(s){if(s.byteLength<16)throw new Error(`QOA file size must be >= ${16}`);let t=new q(s),e=at(t),i=[],r=[];for(let c=0;c<e.channels;c++){let w=new Float32Array(e.samples);i.push(w),r.push(S())}let o=0,a=0;do a=ct(t,e,r,i,o),o+=a;while(a&&o<e.samples);return{...e,channelData:i}}var ht=$.map(s=>Math.floor(((1<<16)+s-1)/s)),ft=[7,7,7,5,5,3,3,1,0,0,2,2,4,4,6,6,6];function ut(s,t){let e=ht[t],i=s*e+(1<<15)>>16;return i=i+((s>0)-(s<0))-((i>0)-(i<0)),i}function _t(s,t,e,i,r){let o=t.channels,a=t.sampleRate,c=t.channelData,w=t.samples,m=Math.floor((r+20-1)/20),M=V(o,m);s.write(o,8),s.write(a,24),s.write(r,16),s.write(M,16);for(let l=0;l<o;l++){let n=e[l];for(let h=0;h<4;h++)s.write(n.history[h],16);for(let h=0;h<4;h++)s.write(n.weights[h],16)}for(let l=0;l<r;l+=20)for(let n=0;n<o;n++){let h=E(20,0,r-l),u=l,d=Number.MAX_SAFE_INTEGER,x,G,Q,N=c[n];for(let f=0;f<16;f++){let b=S(e[n].history,e[n].weights),R=B[f],I=[],A=0,F=u+i;for(let k=0;k<h;k++){let p=N[F++];p=Math.floor(Math.fround(p<0?p*32768:p*32767)),p=E(p,-32768,32767);let O=U(b.weights,b.history),L=p-O,T=ut(L,f),st=E(T,-8,8),W=ft[st+8],X=R[W],j=E(O+X,-32768,32767),v=p-j;if(A+=v*v,A>d)break;Z(b.weights,b.history,j,X),I.push(W)}A<d&&(d=A,x=I,G=f,Q=b)}e[n]=Q,s.write(G,4);for(let f=0;f<20;f++){let b=f<x.length?x[f]:0;s.write(b,3)}}}function et({channelData:s,sampleRate:t=44100}={}){let e=s.length,i=e>=1?s[0].length:0,r={samples:i,channels:e,channelData:s,sampleRate:t},o=(i+5120-1)/5120,a=(i+20-1)/20,c=8+o*8+o*4*4*r.channels+a*8*r.channels,w=[];for(let l=0;l<r.channels;l++){let n=S();n.weights[0]=0,n.weights[1]=0,n.weights[2]=-(1<<13),n.weights[3]=1<<14,w.push(n)}let m=new C(c);m.write(1903124838,32),m.write(i,32);let M=5120;for(let l=0;l<i;l+=M)M=E(5120,0,i-l),_t(m,r,w,l,M);return m.bytes()}export{tt as decode,et as encode};
//# sourceMappingURL=qoa-format-5YQ5ZETV.js.map
