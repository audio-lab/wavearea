function U(){throw new Error("Cycle detected")}function D(){if(O>1)O--;else{for(var t,e=!1;P!==void 0;){var i=P;for(P=void 0,z++;i!==void 0;){var r=i.o;if(i.o=void 0,i.f&=-3,!(8&i.f)&&Q(i))try{i.c()}catch(s){e||(t=s,e=!0)}i=r}}if(z=0,O--,e)throw t}}function Y(t){if(O>0)return t();O++;try{return t()}finally{D()}}var h=void 0,P=void 0,O=0,z=0,$=0;function G(t){if(h!==void 0){var e=t.n;if(e===void 0||e.t!==h)return e={i:0,S:t,p:h.s,n:void 0,t:h,e:void 0,x:void 0,r:e},h.s!==void 0&&(h.s.n=e),h.s=e,t.n=e,32&h.f&&t.S(e),e;if(e.i===-1)return e.i=0,e.n!==void 0&&(e.n.p=e.p,e.p!==void 0&&(e.p.n=e.n),e.p=h.s,e.n=void 0,h.s.n=e,h.s=e),e}}function y(t){this.v=t,this.i=0,this.n=void 0,this.t=void 0}y.prototype.h=function(){return!0};y.prototype.S=function(t){this.t!==t&&t.e===void 0&&(t.x=this.t,this.t!==void 0&&(this.t.e=t),this.t=t)};y.prototype.U=function(t){if(this.t!==void 0){var e=t.e,i=t.x;e!==void 0&&(e.x=i,t.e=void 0),i!==void 0&&(i.e=e,t.x=void 0),t===this.t&&(this.t=i)}};y.prototype.subscribe=function(t){var e=this;return K(function(){var i=e.value,r=32&this.f;this.f&=-33;try{t(i)}finally{this.f|=r}})};y.prototype.valueOf=function(){return this.value};y.prototype.toString=function(){return this.value+""};y.prototype.peek=function(){return this.v};Object.defineProperty(y.prototype,"value",{get:function(){var t=G(this);return t!==void 0&&(t.i=this.i),this.v},set:function(t){if(t!==this.v){z>100&&U(),this.v=t,this.i++,$++,O++;try{for(var e=this.t;e!==void 0;e=e.x)e.t.N()}finally{D()}}}});function J(t){return new y(t)}function Q(t){for(var e=t.s;e!==void 0;e=e.n)if(e.S.i!==e.i||!e.S.h()||e.S.i!==e.i)return!0;return!1}function V(t){for(var e=t.s;e!==void 0;e=e.n){var i=e.S.n;if(i!==void 0&&(e.r=i),e.S.n=e,e.i=-1,e.n===void 0){t.s=e;break}}}function tt(t){for(var e=t.s,i=void 0;e!==void 0;){var r=e.p;e.i===-1?(e.S.U(e),r!==void 0&&(r.n=e.n),e.n!==void 0&&(e.n.p=r)):i=e,e.S.n=e.r,e.r!==void 0&&(e.r=void 0),e=r}t.s=i}function C(t){y.call(this,void 0),this.x=t,this.s=void 0,this.g=$-1,this.f=4}(C.prototype=new y).h=function(){if(this.f&=-3,1&this.f)return!1;if((36&this.f)==32||(this.f&=-5,this.g===$))return!0;if(this.g=$,this.f|=1,this.i>0&&!Q(this))return this.f&=-2,!0;var t=h;try{V(this),h=this;var e=this.x();(16&this.f||this.v!==e||this.i===0)&&(this.v=e,this.f&=-17,this.i++)}catch(i){this.v=i,this.f|=16,this.i++}return h=t,tt(this),this.f&=-2,!0};C.prototype.S=function(t){if(this.t===void 0){this.f|=36;for(var e=this.s;e!==void 0;e=e.n)e.S.S(e)}y.prototype.S.call(this,t)};C.prototype.U=function(t){if(this.t!==void 0&&(y.prototype.U.call(this,t),this.t===void 0)){this.f&=-33;for(var e=this.s;e!==void 0;e=e.n)e.S.U(e)}};C.prototype.N=function(){if(!(2&this.f)){this.f|=6;for(var t=this.t;t!==void 0;t=t.x)t.t.N()}};C.prototype.peek=function(){if(this.h()||U(),16&this.f)throw this.v;return this.v};Object.defineProperty(C.prototype,"value",{get:function(){1&this.f&&U();var t=G(this);if(this.h(),t!==void 0&&(t.i=this.i),16&this.f)throw this.v;return this.v}});function et(t){return new C(t)}function it(t){var e=t.u;if(t.u=void 0,typeof e=="function"){O++;var i=h;h=void 0;try{e()}catch(r){throw t.f&=-2,t.f|=8,H(t),r}finally{h=i,D()}}}function H(t){for(var e=t.s;e!==void 0;e=e.n)e.S.U(e);t.x=void 0,t.s=void 0,it(t)}function yt(t){if(h!==this)throw new Error("Out-of-order effect");tt(this),h=t,this.f&=-2,8&this.f&&H(this),D()}function W(t){this.x=t,this.u=void 0,this.s=void 0,this.o=void 0,this.f=32}W.prototype.c=function(){var t=this.S();try{!(8&this.f)&&this.x!==void 0&&(this.u=this.x())}finally{t()}};W.prototype.S=function(){1&this.f&&U(),this.f|=1,this.f&=-9,it(this),V(this),O++;var t=h;return h=this,yt.bind(this,t)};W.prototype.N=function(){2&this.f||(this.f|=2,this.o=P,P=this)};W.prototype.d=function(){this.f|=8,1&this.f||H(this)};function K(t){var e=new W(t);try{e.c()}catch(i){throw e.d(),i}return e.d.bind(e)}Symbol.observable||=Symbol("observable");var rt=t=>t&&!!(t[Symbol.observable]||t[Symbol.asyncIterator]||t.call&&t.set||t.subscribe||t.then),mt=new FinalizationRegistry(t=>t.call?.()),bt=t=>t&&(()=>t.unsubscribe?.()),nt=(t,e,i,r,s,n)=>t&&(n=bt((t[Symbol.observable]?.()||t).subscribe?.(e,i,r))||t.set&&t.call?.(s,e)||(t.then?.(o=>(!s&&e(o),r?.()),i)||(async o=>{try{for await(o of t){if(s)return;e(o)}r?.()}catch(a){i?.(a)}})())&&(o=>s=1),mt.register(t,n),n);var gt=t=>t&&t.peek,Z=t=>t&&t[ot],ot=Symbol("signal-struct");b.isStruct=Z;function b(t,e){if(Z(t)&&!e)return t;if(L(t)){let i=Object.create(e||Object.getPrototypeOf(t)),r={},s=Object.getOwnPropertyDescriptors(t);for(let n in s){let o=s[n];if(o.get){let a=r[n]=et(o.get.bind(i));Object.defineProperty(i,n,{get(){return a.value},set:o.set?.bind(i),configurable:!1,enumerable:!0})}else{let a=o.value,l=rt(a),u=r[n]=gt(a)?a:J(l?void 0:L(a)?Object.seal(b(a)):Array.isArray(a)?b(a):a);l&&nt(a,d=>u.value=d),Object.defineProperty(i,n,{get(){return u.value},set(d){if(L(d)){if(L(u.value))try{Object.assign(u.value,d);return}catch{}u.value=Object.seal(b(d))}else Array.isArray(d)?u.value=b(d):u.value=d},enumerable:!0,configurable:!1})}}return Object.defineProperty(i,ot,{configurable:!1,enumerable:!1,value:!0}),i}if(Array.isArray(t)&&!Z(t[0]))for(let i=0;i<t.length;i++)t[i]=b(t[i]);return t}function L(t){return t&&t.constructor===Object}function st(t,e,i,r){let s=new Map,n=new Map,o,a;for(o=0;o<e.length;o++)s.set(e[o],o);for(o=0;o<i.length;o++)n.set(i[o],o);for(o=a=0;o!==e.length||a!==i.length;){var l=e[o],u=i[a];if(l===null)o++;else if(i.length<=a)t.removeChild(e[o]),o++;else if(e.length<=o)t.insertBefore(u,e[o]||r),a++;else if(l===u)o++,a++;else{var d=n.get(l),c=s.get(u);d===void 0?(t.removeChild(e[o]),o++):c===void 0?(t.insertBefore(u,e[o]||r),a++):(t.insertBefore(e[c],e[o]||r),e[c]=null,c>o+1&&o++,a++)}}return i}var M={},wt={},St={},at=t=>t===null?wt:t===void 0?St:typeof t=="number"||t instanceof Number?M[t]||(M[t]=new Number(t)):typeof t=="string"||t instanceof String?M[t]||(M[t]=new String(t)):typeof t=="boolean"||t instanceof Boolean?M[t]||(M[t]=new Boolean(t)):t;var B={},g={};B.if=(t,e)=>{let i=document.createTextNode(""),r=[v(t,e,":if")],s=[t],n=t;for(;(n=t.nextElementSibling)&&n.hasAttribute(":else");)n.removeAttribute(":else"),(e=n.getAttribute(":if"))?(n.removeAttribute(":if"),n.remove(),s.push(n),r.push(v(t,e,":else :if"))):(n.remove(),s.push(n),r.push(()=>1));return t.replaceWith(n=i),o=>{let a=r.findIndex(l=>l(o));s[a]!=n&&((n[ft]||n).replaceWith(n=s[a]||i),j(n,o))}};B.with=(t,e,i)=>{let r=v(t,e,"with");j(t,b(r(i),i))};var ft=Symbol(":each");B.each=(t,e)=>{let i=xt(e);if(!i)return I(new Error,t,e);let r=t[ft]=document.createTextNode("");t.replaceWith(r);let s=v(t,i[2],":each"),n=t.getAttribute(":key"),o=n?v(null,n):null;t.removeAttribute(":key");let a=new WeakMap,l=new WeakMap,u=[];return d=>{let c=s(d);c?typeof c=="number"?c=Array.from({length:c},(m,w)=>[w,w+1]):Array.isArray(c)?c=c.map((m,w)=>[w+1,m]):typeof c=="object"?c=Object.entries(c):I(Error("Bad list value"),t,e,":each",c):c=[];let p=[],N=[];for(let[m,w]of c){let k,S,x=o?.({[i[0]]:w,[i[1]]:m});kt(x)&&(x=at(x)),x==null?k=t.cloneNode(!0):(k=l.get(x))||l.set(x,k=t.cloneNode(!0)),p.push(k),x==null||!(S=a.get(x))?(S=b({[i[0]]:w,[i[1]]:m},d),x!=null&&a.set(x,S)):S[i[0]]=w,N.push(S)}st(r.parentNode,u,p,r),u=p;for(let m=0;m<p.length;m++)j(p[m],N[m])}};function xt(t){let e=/,([^,\}\]]*)(?:,([^,\}\]]*))?$/,i=/^\s*\(|\)\s*$/g,r=/([\s\S]*?)\s+(?:in|of)\s+([\s\S]*)/,s=t.match(r);if(!s)return;let n=s[2].trim(),o=s[1].replace(i,"").trim(),a=o.match(e);return a?[o.replace(e,"").trim(),a[1].trim(),n]:[o,"",n]}g.ref=(t,e,i)=>{i[e]=t};g.id=(t,e)=>{let i=v(t,e,":id"),r=s=>t.id=s||s===0?s:"";return s=>r(i(s))};g.class=(t,e)=>{let i=v(t,e,":class"),r=t.className;return s=>{let n=i(s);t.className=r+typeof n=="string"?n:(Array.isArray(n)?n:Object.entries(n).map(([o,a])=>a?o:"")).filter(Boolean).join(" ")}};g.style=(t,e)=>{let i=v(t,e,":style"),r=t.getAttribute("style")||"";return r.endsWith(";")||(r+="; "),s=>{let n=i(s);if(typeof n=="string")t.setAttribute("style",r+n);else for(let o in n)t.style.setProperty(o,n[o])}};g.text=(t,e)=>{let i=v(t,e,":text");return r=>{let s=i(r);t.textContent=s??""}};g.data=(t,e)=>{let i=v(t,e,":data");return r=>{let s=i(r);for(let n in s)t.dataset[n]=s[n]}};g.aria=(t,e)=>{let i=v(t,e,":aria"),r=s=>{for(let n in s)q(t,"aria-"+dt(n),s[n]==null?null:s[n]+"")};return s=>r(i(s))};g[""]=(t,e)=>{let i=v(t,e,":");if(i)return r=>{let s=i(r);for(let n in s)q(t,dt(n),s[n])}};g.value=(t,e)=>{let i=v(t,e,":value"),r,s,n=t.type==="text"||t.type===""?o=>t.setAttribute("value",t.value=o??""):t.tagName==="TEXTAREA"||t.type==="text"||t.type===""?o=>(r=t.selectionStart,s=t.selectionEnd,t.setAttribute("value",t.value=o??""),r&&t.setSelectionRange(r,s)):t.type==="checkbox"?o=>(t.value=o?"on":"",q(t,"checked",o)):t.type==="select-one"?o=>{for(let a in t.options)a.removeAttribute("selected");t.value=o,t.selectedOptions[0]?.setAttribute("selected","")}:o=>t.value=o;return o=>n(i(o))};g.on=(t,e)=>{let i=v(t,e,":on");return r=>{let s=i(r),n=[];for(let o in s)n.push(ct(t,o,s[o]));return()=>{for(let o of n)o()}}};var ut=(t,e,i,r)=>{let s=r.startsWith("on")&&r.slice(2),n=v(t,e,":"+r);if(n)return s?o=>{let a=n(o)||(()=>{});return ct(t,s,a)}:o=>q(t,r,n(o))},ct=(t,e,i)=>{let r=e.split("..").map(a=>{let l={evt:"",target:t,test:()=>!0};return l.evt=(a.startsWith("on")?a.slice(2):a).replace(/\.(\w+)?-?([\w]+)?/g,(u,d,c)=>(l.test=Nt[d]?.(l,c)||l.test,"")),l});if(r.length==1)return o(i,r[0]);let s,n=(a,l=0)=>s=o(d=>{s(),typeof(a=a.call(t,d))!="function"&&(a=()=>{}),++l<r.length?n(a,l):n(i)},r[l]);return n(i),()=>s();function o(a,{evt:l,target:u,test:d,throttle:c,debounce:p,stop:N,prevent:m,...w}){c?a=At(a,c):p&&(a=Ot(a,p));let k=S=>d(S)&&(N&&S.stopPropagation(),m&&S.preventDefault(),a.call(u,S));return u.addEventListener(l,k,w),()=>u.removeEventListener(l,k,w)}},Nt={prevent(t){t.prevent=!0},stop(t){t.stop=!0},once(t){t.once=!0},passive(t){t.passive=!0},capture(t){t.capture=!0},window(t){t.target=window},document(t){t.target=document},throttle(t,e){t.throttle=Number(e)||108},debounce(t,e){t.debounce=Number(e)||108},outside:t=>e=>{let i=t.target;return!(i.contains(e.target)||e.target.isConnected===!1||i.offsetWidth<1&&i.offsetHeight<1)},self:t=>e=>e.target===t.target,ctrl:t=>e=>e.key==="Control"||e.key==="Ctrl",shift:t=>e=>e.key==="Shift",alt:t=>e=>e.key==="Alt",meta:t=>e=>e.key==="Meta",arrow:t=>e=>e.key.startsWith("Arrow"),enter:t=>e=>e.key==="Enter",escape:t=>e=>e.key.startsWith("Esc"),tab:t=>e=>e.key==="Tab",space:t=>e=>e.key==="Space"||e.key===" ",backspace:t=>e=>e.key==="Backspace",delete:t=>e=>e.key==="Delete",digit:t=>e=>/^\d$/.test(e.key),letter:t=>e=>/^[a-zA-Z]$/.test(e.key),character:t=>e=>/^\S$/.test(e.key)},At=(t,e)=>{let i,r,s=n=>{i=!0,setTimeout(()=>{if(i=!1,r)return r=!1,s(n),t(n)},e)};return n=>i?r=!0:(s(n),t(n))},Ot=(t,e)=>{let i;return r=>{clearTimeout(i),i=setTimeout(()=>{i=null,t(r)},e)}},q=(t,e,i)=>{i==null||i===!1?t.removeAttribute(e):t.setAttribute(e,i===!0?"":typeof i=="number"||typeof i=="string"?i:"")},lt={};function v(t,e,i){let r=lt[e];if(!r){let s=/^[\n\s]*if.*\(.*\)/.test(e)||/\b(let|const)\s/.test(e)?`(() => { ${e} })()`:e;try{r=lt[e]=new Function("__scope",`with (__scope) { return ${s} };`)}catch(n){return I(n,t,e,i)}}return s=>{let n;try{n=r.call(t,s)}catch(o){return I(o,t,e,i)}return n}}function I(t,e,i,r){Object.assign(t,{element:e,expression:i}),console.warn(`\u2234 ${t.message}

${r}=${i?`"${i}"

`:""}`,e),setTimeout(()=>{throw t},0)}function dt(t){return t.replace(/[A-Z\u00C0-\u00D6\u00D8-\u00DE]/g,e=>"-"+e.toLowerCase())}function kt(t){return typeof t=="string"||typeof t=="boolean"||typeof t=="number"}var R=new WeakMap;function j(t,e){if(!t.children)return;if(R.has(t)){let n=R.get(t);return Y(()=>Object.assign(n,e)),n}let i=b(e||{}),r=[],s=(n,o=n.parentNode)=>{for(let a in B){let l=":"+a;if(n.hasAttribute?.(l)){let u=n.getAttribute(l);if(n.removeAttribute(l),r.push(B[a](n,u,i,a)),R.has(n)||n.parentNode!==o)return!1}}if(n.attributes)for(let a=0;a<n.attributes.length;){let l=n.attributes[a];if(l.name[0]!==":"){a++;continue}n.removeAttribute(l.name);let u=l.value,d=l.name.slice(1).split(":");for(let c of d){let p=g[c]||ut;if(r.push(p(n,u,i,c)),R.has(n)||n.parentNode!==o)return!1}}for(let a=0,l;l=n.children[a];a++)s(l,n)===!1&&a--};s(t);for(let n of r)if(n){let o;K(()=>{typeof o=="function"&&o(),o=n(i)})}return Object.seal(i),R.set(t,i),i}var ht=j;var Ct=1080,F=document.querySelector(".wavearea"),A=F.querySelector(".w-editable"),T=F.querySelector(".w-playback"),jt=F.querySelector(".w-play"),X=new Worker("./dist/worker.js",{type:"module"}),pt=0;X.addEventListener("message",t=>{let{id:e,url:i,segments:r,duration:s}=t.data;e<pt||(pt=e,T.src=i,f.loading=!1,f.total?console.assert(r.join("")===A.textContent,"Rendered waveform is different from UI"):f.segments=r,f.total=r.reduce((n,o)=>n+=o.length,0),f.duration=s)});var _=new URL(location);if(_.search.length<2){let t=["https://upload.wikimedia.org/wikipedia/commons/c/cf/Caja_de_m%C3%BAsica_%28PianoConcerto5_Beethoven%29.ogg"],e=t[Math.floor(Math.random()*t.length)];vt(["src",e])}else for(let[t,e]of _.searchParams)e.split("..").map(i=>X.postMessage([t,...i.includes(":")?[i]:i.split("-")]));function vt(...t){for(let e of t){let[i,...r]=e;_.searchParams.has(i)?_.searchParams.set(i,`${_.searchParams.get(i)}..${r.join("-")}`):_.searchParams.append(i,r.join("-")),X.postMessage(e)}history.pushState(null,"",decodeURI(_))}var f=ht(F,{loading:!0,recording:!1,playing:!1,selecting:!1,playbackStart:0,loop:!1,playbackEnd:null,volume:1,segments:[],total:0,duration:0,caretOffset:0,lineWidth:216,isMouseDown:!1,handleCaret(t){document.addEventListener("selectionchange",e=>{let i=E();i&&(f.caretOffset=i.start,f.playbackStart=i.start,f.loop=!i.collapsed,f.playbackEnd=f.loop?i.end:null,T.currentTime=f.duration*f.playbackStart/f.total)},{once:!0})},updateTimecodes(){let t=0,e=0;for(let i of A.children){let r=i.textContent.trim(),s=Math.ceil(r.length/f.lineWidth);i.dataset.id=e++,i.dataset.offset=t,i.setAttribute("timecodes",Array.from({length:s},(n,o)=>Tt(o*f.lineWidth+t)).join(`
`)),t+=r.length}},async handleBeforeInput(t){let e=Et[t.inputType];e?e.call(this,t):t.preventDefault()},async handleDrop(t){let i=t.dataTransfer.files[0];if(!i.type.startsWith("audio"))return!1;f.loading=!0,f.segments=[];let r=await fileToArrayBuffer(i),s=await decodeAudio(r),n=await encodeAudio(s),o=new Blob([n],{type:"audio/wav"}),a=URL.createObjectURL(o);return await applyOp(["src",a]),f.loading=!1,r},timeChange(t){document.activeElement!==A&&(E(f.playbackStart=Math.floor(f.total*T.currentTime/f.duration)),A.focus())},play(t){f.playing=!0;let e=E();e||(e=E(0));let i=f.caretOffset,r=e.collapsed?f.total:e.end,s,n=()=>{let o=Math.max(Math.ceil(f.total*T.currentTime/f.duration)-f.playbackStart,0),a=f.playbackStart+o;E(f.caretOffset=a),r&&a>=r?jt.click():s=requestAnimationFrame(n)};return n(),A.focus(),T.play(),()=>{T.pause(),f.playing=!1,cancelAnimationFrame(s),s=null,e.start!==e.end&&E(i,r),T.currentTime>=f.duration&&E(f.total),A.focus()}}}),Et={async deleteContentBackward(t){let e=t.getTargetRanges()[0],i=e.startOffset+Number(e.startContainer.parentNode.dataset.offset),r=e.endOffset+Number(e.endContainer.parentNode.dataset.offset),s=r-i;this._deleteTimeout?(clearTimeout(this._deleteTimeout),this._deleteOp[1]--,this._deleteOp[2]++):this._deleteOp=["del",i,s],this._deleteTimeout=setTimeout(()=>{vt(this._deleteOp),this._deleteOp=this._deleteTimeout=null},Ct)}},E=(t,e,i=0)=>{let r=window.getSelection();if(t!=null){t=Math.max(0,t),e==null&&(e=t);let u,d;r.removeAllRanges();let c=new Range,p=t;for(u=A.firstChild;p+i>u.firstChild.data.length;)p-=u.firstChild.data.length,u=u.nextSibling;c.setStart(u.firstChild,p);let N=e;for(d=A.firstChild;N+i>d.firstChild.data.length;)N-=d.firstChild.data.length,d=d.nextSibling;return c.setEnd(d.firstChild,N),r.addRange(c),{start:t,startNode:u,end:e,endNode:d,startNodeOffset:p,endNodeOffset:N,collapsed:r.isCollapsed}}if(!r.anchorNode||r.anchorNode.parentNode.parentNode!==A)return;t=r.anchorOffset,e=r.focusOffset;let s=r.anchorNode.parentNode;for(;s=s.previousSibling;)t+=s.firstChild.data.length;for(s=r.focusNode.parentNode;s=s.previousSibling;)e+=s.firstChild.data.length;let n=r.anchorNode.parentNode,o=r.anchorOffset,a=r.focusNode.parentNode,l=r.focusOffset;return t>e&&([e,a,l,t,n,o]=[t,n,o,e,a,l]),{start:t,startNode:n,startNodeOffset:o,end:e,endNode:a,endNodeOffset:l,collapsed:r.isCollapsed}},Tt=t=>{let e=t/f.total*f.duration;return`${Math.floor(e/60).toFixed(0)}:${(Math.floor(e)%60).toFixed(0).padStart(2,0)}`};export{Ct as KEY_DEBOUNCE};
//# sourceMappingURL=wavearea.js.map
