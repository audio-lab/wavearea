var W=Object.create;var B=Object.defineProperty;var Y=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames;var j=Object.getPrototypeOf,z=Object.prototype.hasOwnProperty;var C=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var J=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of $(t))!z.call(e,a)&&a!==n&&B(e,a,{get:()=>t[a],enumerable:!(r=Y(t,a))||r.enumerable});return e};var Q=(e,t,n)=>(n=e!=null?W(j(e)):{},J(t||!e||!e.__esModule?B(n,"default",{value:e,enumerable:!0}):n,e));var _=C((oe,T)=>{"use strict";T.exports=function(e){return!e||e.length<3?!1:e[0]===73&&e[1]===68&&e[2]===51||e[0]===255&&(e[1]===251||e[1]===250)}});var M=C((se,L)=>{"use strict";L.exports=function(e){return!e||e.length<12?!1:e[0]===82&&e[1]===73&&e[2]===70&&e[3]===70&&e[8]===87&&e[9]===65&&e[10]===86&&e[11]===69}});var U=C((he,F)=>{"use strict";F.exports=function(e){return!e||e.length<4?!1:e[0]===79&&e[1]===103&&e[2]===103&&e[3]===83}});var q=C((ie,k)=>{"use strict";k.exports=function(e){return!e||e.length<4?!1:e[0]===102&&e[1]===76&&e[2]===97&&e[3]===67}});var S=C((ce,P)=>{"use strict";P.exports=function(e){return!e||e.length<8?!1:e[4]===102&&e[5]===116&&e[6]===121&&e[7]===112||e[0]===77&&e[1]===52&&e[2]===65&&e[3]===32}});var N=C((ue,K)=>{"use strict";K.exports=function(e){return e?_()(e)?"mp3":M()(e)?"wav":U()(e)?"oga":q()(e)?"flac":S()(e)?"m4a":!1:!1}});var f=class{constructor(t){if(!t)throw TypeError("options argument is required");if(!t.sampleRate)throw TypeError("options.sampleRate is required");if(t.sampleRate<3e3||t.sampleRate>768e3)throw TypeError("options.sampleRate must be within 3000..768000");if(!t.length)throw TypeError("options.length must be more than 0");this.sampleRate=t.sampleRate,this.numberOfChannels=t.numberOfChannels||1,this.length=t.length|0,this.duration=this.length/this.sampleRate,this._data=new Float32Array(this.length*this.numberOfChannels),this._channelData=[];for(let n=0;n<this.numberOfChannels;n++)this._channelData.push(this._data.subarray(n*this.length,(n+1)*this.length))}getChannelData(t){if(t>=this.numberOfChannels||t<0||t==null)throw Error("Cannot getChannelData: channel number ("+t+") exceeds number of channels ("+this.numberOfChannels+")");return this._channelData[t]}copyFromChannel(t,n,r){r==null&&(r=0);for(var a=this._channelData[n],l=r,o=0;l<this.length&&o<t.length;l++,o++)t[o]=a[l]}copyToChannel(t,n,r){var a=this._channelData[n];r||(r=0);for(var l=r,o=0;l<this.length&&o<t.length;l++,o++)a[l]=t[o]}};var V=Q(N());var v={},X=async e=>{let t=new Uint8Array(e),n=(0,V.default)(t);return await(await ee(n))(e)},ee=async e=>{if(v[e])return v[e];let t;switch(e){case"mp3":let{MPEGDecoder:n}=await R("mp3");t=new n;break;case"ogg":case"oga":let{OggVorbisDecoder:r}=await R("ogg");t=new r;break;case"flac":let{FLACDecoder:a}=await R("flac");t=new a().decodeFile;break;case"opus":let{OpusDecoder:l}=await R("opus");t=new l().decode;break;default:throw Error(e?"Unsupported codec "+e:"Unknown codec")}return await t.ready,v[e]=async n=>{console.time("decode");let{channelData:r,sampleRate:a}=t.decodeFile?await t.decodeFile(new Uint8Array(n)):await t.decode(n);console.timeEnd("decode");let l=new f({sampleRate:a,length:r[0].length,numberOfChannels:r.length});for(let o=0;o<r.length;o++)l.getChannelData(o).set(r[o]);return l}},R=e=>{console.time("load decoder "+e);let t=import("./decoder/"+e+".js");return console.timeEnd("load decoder "+e),t},b=X;async function Z(e){console.time("fetch");let t=await fetch(e,{cache:"force-cache"});if(console.timeEnd("fetch"),!t.ok)throw new Error(`HTTP error: status=${t.status}`);let n=await t.arrayBuffer();return b(n)}async function I(...e){console.time("wav encode");let t=e[0]?.sampleRate||44100,n=32,r=e[0]?.numberOfChannels||1,a=0;for(let h of e)a+=h.length;let l=new ArrayBuffer(44+a*r*(n>>3)),o=new DataView(l),d=0,g=h=>o.setUint8(d++,h),c=h=>(o.setUint16(d,h,!0),d+=2),i=h=>(o.setUint32(d,h,!0),d+=4),u=h=>{for(var m=0;m<h.length;++m)g(h.charCodeAt(m))};u("RIFF"),i(l.byteLength-8),u("WAVE"),u("fmt "),i(16),c(3),c(r),i(t),i(t*r*(n>>3)),c(r*(n>>3)),c(n),u("data"),i(l.byteLength-44);let D=new Float32Array(l,d);for(let h of e){let m=h.numberOfChannels,w=Array(m),H=h.length;for(let p=0;p<m;++p)w[p]=h.getChannelData(p);for(let p=0;p<H;++p)for(let E=0;E<m;++E)D[d++]=w[E][p]}return console.timeEnd("wav encode"),l}function G(e){if(!e)return"";if(e._wf)return e._wf;let t=e.getChannelData(0),n="",r=2;for(let a=0,l=1024;a<t.length;){let o=0,d=0;for(;a<l;a++)o+=a>=t.length?0:t[a]**2;let g=Math.sqrt(o/1024),c=Math.min(100,Math.ceil(g*100*r));n+=String.fromCharCode(256+c),l+=1024}return e._wf=n,n}function A(e,t=0,n=e.length){let r=new f({length:n-t,numberOfChannels:e.numberOfChannels,sampleRate:e.sampleRate});for(var a=0;a<r.numberOfChannels;a++)r.copyToChannel(e.getChannelData(a).subarray(t,n),a,0);return r}self.onmessage=async e=>{let{id:t,ops:n}=e.data,r;for(;t<O.length;)O.pop()();for(let c of n){console.log("Apply op",c);let[i,...u]=c;r=await ne[i]?.(...u)}let a=r.map(c=>G(c).replaceAll("\u0100"," ")),l=r.reduce((c,{duration:i})=>c+i,0),o=await I(...r),d=new Blob([o],{type:"audio/wav"}),g=URL.createObjectURL(d);self.postMessage({id:O.length,url:g,segments:a,duration:l})};var O=[],s=[],ne={async src(...e){return O.push(()=>s=[]),s=await Promise.all(e.map(Z)),s},del(e,t){e=Number(e),t=Number(t);let n=[...s];O.push(()=>{s=n});let r=x(e),a=x(t);!a[1]&&a[0]&&(a[0]-=1,a[1]=s[a[0]].length);let l=s[r[0]],o=s[a[0]],d=r[1]+(o.length-a[1]);if(!d)return s=[];let g=new f({length:d,sampleRate:l.sampleRate,numberOfChannels:l.numberOfChannels});for(let i=0;i<l.numberOfChannels;i++){let u=0,D=g.getChannelData(i),h=l.getChannelData(i),m=o.getChannelData(i);for(u=0;u<r[1];u++)D[u]=h[u];for(let w=a[1];w<m.length;w++)D[u]=m[w],u++}let c=s.splice(r[0],a[0]-r[0]+1,g);return s},loop(e,t){e=Number(e),t=Number(t);let n=x(e),r=x(t);return n[0]===r[0]?[A(s[n[0]],n[1],r[1])]:n[0]===r[0]-1?[A(s[n[0]],n[1]),A(s[r[0]],0,r[1])]:[A(s[n[0]],n[1]),...s.slice(n[0]+1,r[0]-1),A(s[r[0]],0,r[1])]},goto(e){}},x=e=>{let t=e*1024;if(t===0)return[0,0];var n=0,r;for(let a=0;a<s.length;a++){if(r=n+s[a].length,t<r)return[a,t-n];n=r}return[s.length-1,s[s.length-1].length]};
//# sourceMappingURL=worker.js.map
