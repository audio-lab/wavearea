var W=Object.create;var v=Object.defineProperty;var Y=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames;var j=Object.getPrototypeOf,z=Object.prototype.hasOwnProperty;var w=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var J=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of $(t))!z.call(e,a)&&a!==n&&v(e,a,{get:()=>t[a],enumerable:!(r=Y(t,a))||r.enumerable});return e};var Q=(e,t,n)=>(n=e!=null?W(j(e)):{},J(t||!e||!e.__esModule?v(n,"default",{value:e,enumerable:!0}):n,e));var T=w((oe,B)=>{"use strict";B.exports=function(e){return!e||e.length<3?!1:e[0]===73&&e[1]===68&&e[2]===51||e[0]===255&&(e[1]===251||e[1]===250)}});var L=w((se,_)=>{"use strict";_.exports=function(e){return!e||e.length<12?!1:e[0]===82&&e[1]===73&&e[2]===70&&e[3]===70&&e[8]===87&&e[9]===65&&e[10]===86&&e[11]===69}});var F=w((he,M)=>{"use strict";M.exports=function(e){return!e||e.length<4?!1:e[0]===79&&e[1]===103&&e[2]===103&&e[3]===83}});var k=w((ie,U)=>{"use strict";U.exports=function(e){return!e||e.length<4?!1:e[0]===102&&e[1]===76&&e[2]===97&&e[3]===67}});var P=w((ue,q)=>{"use strict";q.exports=function(e){return!e||e.length<8?!1:e[4]===102&&e[5]===116&&e[6]===121&&e[7]===112||e[0]===77&&e[1]===52&&e[2]===65&&e[3]===32}});var K=w((ce,S)=>{"use strict";S.exports=function(e){return e?T()(e)?"mp3":L()(e)?"wav":F()(e)?"oga":k()(e)?"flac":P()(e)?"m4a":!1:!1}});var m=class{constructor(t){if(!t)throw TypeError("options argument is required");if(!t.sampleRate)throw TypeError("options.sampleRate is required");if(t.sampleRate<3e3||t.sampleRate>768e3)throw TypeError("options.sampleRate must be within 3000..768000");if(!t.length)throw TypeError("options.length must be more than 0");this.sampleRate=t.sampleRate,this.numberOfChannels=t.numberOfChannels||1,this.length=t.length|0,this.duration=this.length/this.sampleRate,this._data=new Float32Array(this.length*this.numberOfChannels),this._channelData=[];for(let n=0;n<this.numberOfChannels;n++)this._channelData.push(this._data.subarray(n*this.length,(n+1)*this.length))}getChannelData(t){if(t>=this.numberOfChannels||t<0||t==null)throw Error("Cannot getChannelData: channel number ("+t+") exceeds number of channels ("+this.numberOfChannels+")");return this._channelData[t]}copyFromChannel(t,n,r){r==null&&(r=0);for(var a=this._channelData[n],l=r,o=0;l<this.length&&o<t.length;l++,o++)t[o]=a[l]}copyToChannel(t,n,r){var a=this._channelData[n];r||(r=0);for(var l=r,o=0;l<this.length&&o<t.length;l++,o++)a[l]=t[o]}};var N=Q(K());var x={},X=async e=>{let t=new Uint8Array(e),n=(0,N.default)(t);return await(await ee(n))(e)},ee=async e=>{if(x[e])return x[e];let t;switch(e){case"mp3":let{MPEGDecoder:n}=await O("mp3");t=new n;break;case"ogg":case"oga":let{OggVorbisDecoder:r}=await O("ogg");t=new r;break;case"flac":let{FLACDecoder:a}=await O("flac");t=new a().decodeFile;break;case"opus":let{OpusDecoder:l}=await O("opus");t=new l().decode;break;default:throw Error(e?"Unsupported codec "+e:"Unknown codec")}return await t.ready,x[e]=async n=>{console.time("decode");let{channelData:r,sampleRate:a}=t.decodeFile?await t.decodeFile(new Uint8Array(n)):await t.decode(n);console.timeEnd("decode");let l=new m({sampleRate:a,length:r[0].length,numberOfChannels:r.length});for(let o=0;o<r.length;o++)l.getChannelData(o).set(r[o]);return l}},O=e=>{console.time("load decoder "+e);let t=import("./decoder/"+e+".js");return console.timeEnd("load decoder "+e),t},V=X;async function b(e){console.time("fetch");let t=await fetch(e);if(!t.ok)throw new Error(`HTTP error: status=${t.status}`);let n=await t.arrayBuffer();return console.timeEnd("fetch"),V(n)}async function Z(...e){console.time("wav encode");let t=e[0]?.sampleRate||44100,n=32,r=e[0]?.numberOfChannels||1,a=0;for(let i of e)a+=i.length;let l=new ArrayBuffer(44+a*r*(n>>3)),o=new DataView(l),c=0,u=i=>o.setUint8(c++,i),h=i=>(o.setUint16(c,i,!0),c+=2),d=i=>(o.setUint32(c,i,!0),c+=4),p=i=>{for(var g=0;g<i.length;++g)u(i.charCodeAt(g))};p("RIFF"),d(l.byteLength-8),p("WAVE"),p("fmt "),d(16),h(3),h(r),d(t),d(t*r*(n>>3)),h(r*(n>>3)),h(n),p("data"),d(l.byteLength-44);let y=new Float32Array(l,c);for(let i of e){let g=i.numberOfChannels,E=Array(g),H=i.length;for(let f=0;f<g;++f)E[f]=i.getChannelData(f);for(let f=0;f<H;++f)for(let R=0;R<g;++R)y[c++]=E[R][f]}return console.timeEnd("wav encode"),l}function I(e){if(!e)return"";if(e._wf)return e._wf;let t=e.getChannelData(0),n="",r=2;for(let a=0,l=1024;a<t.length;){let o=0,c=0;for(;a<l;a++)o+=a>=t.length?0:t[a]**2;let u=Math.sqrt(o/1024),h=Math.min(100,Math.ceil(u*100*r));n+=String.fromCharCode(256+h),l+=1024}return e._wf=n,n}function C(e,t=0,n=e.length){let r=new m({length:n-t,numberOfChannels:e.numberOfChannels,sampleRate:e.sampleRate});for(var a=0;a<r.numberOfChannels;a++)r.copyToChannel(e.getChannelData(a).subarray(t,n),a,0);return r}self.onmessage=async e=>{let t=e.data,n;for(let u of t){console.log("Apply op",u);let[h,...d]=u;n=await ne[h]?.(...d)}let r=n.map(u=>I(u).replaceAll("\u0100"," ")),a=n.reduce((u,{duration:h})=>u+h,0),l=await Z(...n),o=new Blob([l],{type:"audio/wav"}),c=URL.createObjectURL(o);self.postMessage({url:c,segments:r,duration:a})};var G=[],s=[],ne={async src(...e){return G.push(()=>s=[]),s=await Promise.all(e.map(b)),s},del(e,t){if(e=Number(e),t=Number(t),!t)return s;let n=D(e),r=D(e+t);!r[1]&&r[0]&&(r[0]-=1,r[1]=s[r[0]].length);let a=s[n[0]],l=s[r[0]],o=new m({length:n[1]+(l.length-r[1]),sampleRate:a.sampleRate,numberOfChannels:a.numberOfChannels});for(let u=0;u<a.numberOfChannels;u++){let h=0,d=o.getChannelData(u),p=a.getChannelData(u),y=l.getChannelData(u);for(h=0;h<n[1];h++)d[h]=p[h];for(let i=r[1];i<y.length;i++)d[h]=y[i],h++}let c=s.splice(n[0],r[0]-n[0]+1,o);return G.push(()=>{}),s},loop(e,t){e=Number(e),t=Number(t);let n=D(e),r=D(t);return n[0]===r[0]?[C(s[n[0]],n[1],r[1])]:n[0]===r[0]-1?[C(s[n[0]],n[1]),C(s[r[0]],0,r[1])]:[C(s[n[0]],n[1]),...s.slice(n[0]+1,r[0]-1),C(s[r[0]],0,r[1])]}},D=e=>{let t=e*1024;if(t===0)return[0,0];var n=0,r;for(let a=0;a<s.length;a++){if(r=n+s[a].length,t<r)return[a,t-n];n=r}return[s.length-1,s[s.length-1].length]};
//# sourceMappingURL=worker.js.map
