var $=Object.create;var v=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var Q=Object.getPrototypeOf,X=Object.prototype.hasOwnProperty;var C=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var ee=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of J(t))!X.call(e,a)&&a!==n&&v(e,a,{get:()=>t[a],enumerable:!(r=z(t,a))||r.enumerable});return e};var te=(e,t,n)=>(n=e!=null?$(Q(e)):{},ee(t||!e||!e.__esModule?v(n,"default",{value:e,enumerable:!0}):n,e));var b=C((ie,B)=>{"use strict";B.exports=function(e){return!e||e.length<3?!1:e[0]===73&&e[1]===68&&e[2]===51||e[0]===255&&(e[1]===251||e[1]===250)}});var _=C((ue,T)=>{"use strict";T.exports=function(e){return!e||e.length<12?!1:e[0]===82&&e[1]===73&&e[2]===70&&e[3]===70&&e[8]===87&&e[9]===65&&e[10]===86&&e[11]===69}});var L=C((fe,M)=>{"use strict";M.exports=function(e){return!e||e.length<4?!1:e[0]===79&&e[1]===103&&e[2]===103&&e[3]===83}});var S=C((ce,q)=>{"use strict";q.exports=function(e){return!e||e.length<4?!1:e[0]===102&&e[1]===76&&e[2]===97&&e[3]===67}});var k=C((me,U)=>{"use strict";U.exports=function(e){return!e||e.length<8?!1:e[4]===102&&e[5]===116&&e[6]===121&&e[7]===112||e[0]===77&&e[1]===52&&e[2]===65&&e[3]===32}});var F=C((ge,P)=>{"use strict";P.exports=function(e){return e?b()(e)?"mp3":_()(e)?"wav":L()(e)?"oga":S()(e)?"flac":k()(e)?"m4a":!1:!1}});var m=class{constructor(t){if(!t)throw TypeError("options argument is required");if(!t.sampleRate)throw TypeError("options.sampleRate is required");if(t.sampleRate<3e3||t.sampleRate>768e3)throw TypeError("options.sampleRate must be within 3000..768000");if(!t.length)throw TypeError("options.length must be more than 0");this.sampleRate=t.sampleRate,this.numberOfChannels=t.numberOfChannels||1,this.length=t.length|0,this.duration=this.length/this.sampleRate,this._data=new Float32Array(this.length*this.numberOfChannels),this._channelData=[];for(let n=0;n<this.numberOfChannels;n++)this._channelData.push(this._data.subarray(n*this.length,(n+1)*this.length))}getChannelData(t){if(t>=this.numberOfChannels||t<0||t==null)throw Error("Cannot getChannelData: channel number ("+t+") exceeds number of channels ("+this.numberOfChannels+")");return this._channelData[t]}copyFromChannel(t,n,r){r==null&&(r=0);for(var a=this._channelData[n],h=r,l=0;h<this.length&&l<t.length;h++,l++)t[l]=a[h]}copyToChannel(t,n,r){var a=this._channelData[n];r||(r=0);for(var h=r,l=0;h<this.length&&l<t.length;h++,l++)a[h]=t[l]}};var K=te(F());var x={},ne=async e=>{let t=new Uint8Array(e),n=(0,K.default)(t),r=await re(n);console.time("decode");let a=await r(e);return console.timeEnd("decode"),a},re=async e=>{if(x[e])return x[e];let t;switch(e){case"mp3":let{MPEGDecoderWebWorker:n}=await I("mp3");t=new n;break;case"ogg":case"oga":let{OGGDecoder:r}=await I("ogg");t=new r;break;default:throw Error(e?"Unsupported codec "+e:"Unknown codec")}return await t.ready,x[e]=async n=>{let{channelData:r,sampleRate:a,...h}=await t.decode(n),l=new m({sampleRate:a,length:r[0].length,numberOfChannels:r.length});for(let s=0;s<r.length;s++)l.getChannelData(s).set(r[s]);return l}},I=e=>{console.time("load decoder "+e);let t=import("./decoder/"+e+".js");return console.timeEnd("load decoder "+e),t},W=ne;async function G(e){console.time("fetch");let t=await fetch(e);if(!t.ok)throw new Error(`HTTP error: status=${t.status}`);let n=await t.arrayBuffer();return console.timeEnd("fetch"),W(n)}async function V(...e){console.time("wav encode");let t=e[0]?.sampleRate||44100,n=32,r=e[0]?.numberOfChannels||1,a=0;for(let f of e)a+=f.length;let h=new ArrayBuffer(44+a*r*(n>>3)),l=new DataView(h),s=0,u=f=>l.setUint8(s++,f),o=f=>(l.setUint16(s,f,!0),s+=2),c=f=>(l.setUint32(s,f,!0),s+=4),p=f=>{for(var d=0;d<f.length;++d)u(f.charCodeAt(d))};p("RIFF"),c(h.byteLength-8),p("WAVE"),p("fmt "),c(16),o(3),o(r),c(t),c(t*r*(n>>3)),o(r*(n>>3)),o(n),p("data"),c(h.byteLength-44);let D=new Float32Array(h,s);for(let f of e){let d=f.numberOfChannels,E=Array(d),Y=f.length;for(let g=0;g<d;++g)E[g]=f.getChannelData(g);for(let g=0;g<Y;++g)for(let y=0;y<d;++y)D[s++]=E[y][g]}return console.timeEnd("wav encode"),h}function Z(e){if(!e)return"";if(e._wf)return e._wf;console.time("to waveform string");let t=e.getChannelData(0),n="",r=2;for(let a=0,h=1024;a<t.length;){let l=0,s=0;for(;a<h;a++)l+=a>=t.length?0:t[a]**2;let u=Math.sqrt(l/1024),o=Math.min(100,Math.ceil(u*100*r));n+=String.fromCharCode(256+o),h+=1024}return e._wf=n,console.timeEnd("to waveform string"),n}function j(e){let t=new m({sampleRate:e.sampleRate,numberOfChannels:e.numberOfChannels,length:e.length});for(let n=0;n<e.numberOfChannels;n++)t.getChannelData(n).set(e.getChannelData(n));return t}var ae=[],N=0,A=[];self.onmessage=async e=>{A.push(e.data),A.length===1&&H()};var H=async()=>{let e=A[0];console.log("Apply op",e);let[t,...n]=e,r=await le[t]?.(...n);if(ae.push(r),A.shift(),A.length)return H();let a=i.map(o=>Z(o).replaceAll("\u0100"," ")),h=i.reduce((o,{duration:c})=>o+c,0),l=await V(...i),s=new Blob([l],{type:"audio/wav"}),u=URL.createObjectURL(s);N++,self.postMessage({id:N,url:u,segments:a,duration:h})},i=[],le={async src(...e){return i=await Promise.all(e.map(G)),()=>i=[]},norm(){let e=i.map(l=>j(l)),t=0,n=0;for(let l of i)for(let s=0;s<l.numberOfChannels;s++){let u=l.getChannelData(s);n+=u.length;for(let o=0;o<u.length;o++)t+=u[o]}let r=t/n;for(let l of i)for(let s=0;s<l.numberOfChannels;s++){let u=l.getChannelData(s);n+=u.length;for(let o=0;o<u.length;o++)u[o]-=r}let a=0;for(let l of i)for(let s=0;s<l.numberOfChannels;s++){let u=l.getChannelData(s);for(let o=0;o<u.length;o++)a=Math.max(Math.abs(u[o]),a)}let h=Math.max(1/a,1);for(let l of i)for(let s=0;s<l.numberOfChannels;s++){let u=l.getChannelData(s);for(let o=0;o<u.length;o++)u[o]=Math.min(1,Math.max(-1,u[o]*h))}return()=>e},br(e,...t){for(let n of t){let[r,a]=O(n),h=e[r];if(a>0&&a<h.length){let l=sliceAudio(h,0,a),s=sliceAudio(h,a);e.splice(r,1,l,s)}}return e},join(e){let[t,n]=O(e);if(n)return console.warn("Wrong buffer offset",e);let r=i[t-1],a=i[t];return i.splice(t-1,2,joinAudio(r,a)),i},del(e,t){if(e=Number(e),t=Number(t),!t)return i;let n=O(e),r=O(e+t);!r[1]&&r[0]&&(r[0]-=1,r[1]=i[r[0]].length);let a=i[n[0]],h=i[r[0]],l=new m({length:n[1]+(h.length-r[1]),sampleRate:a.sampleRate,numberOfChannels:a.numberOfChannels});for(let u=0;u<a.numberOfChannels;u++){let o=0,c=l.getChannelData(u),p=a.getChannelData(u),D=h.getChannelData(u);for(o=0;o<n[1];o++)c[o]=p[o];for(let f=r[1];f<D.length;f++)c[o]=D[f],o++}let s=i.splice(n[0],r[0]-n[0]+1,l);return()=>{}},mute(...e){for(let t of e){let[n,r]=t,[a,h]=O(n);!h&&a&&(a-=1,h=i[a].length);let l=new m({length:r*1024,numberOfChannels:i?.[0].numberOfChannels||1,sampleRate:i?.[0].sampleRate||44100});i[a]=insertAudio(i[a],h,l)}return i},clip(e,t){},add(e,t){},cp(e,t,n){},undo(){}},O=e=>{let t=e*1024;if(t===0)return[0,0];var n=0,r;for(let a=0;a<i.length;a++){if(r=n+i[a].length,t<r)return[a,t-n];n=r}return[i.length-1,i[i.length-1].length]};
//# sourceMappingURL=worker.js.map
