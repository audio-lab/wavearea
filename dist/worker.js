var Re=Object.create;var Q=Object.defineProperty;var Pe=Object.getOwnPropertyDescriptor;var Be=Object.getOwnPropertyNames;var Me=Object.getPrototypeOf,Te=Object.prototype.hasOwnProperty;var B=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var Le=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of Be(t))!Te.call(e,o)&&o!==n&&Q(e,o,{get:()=>t[o],enumerable:!(r=Pe(t,o))||r.enumerable});return e};var ee=(e,t,n)=>(n=e!=null?Re(Me(e)):{},Le(t||!e||!e.__esModule?Q(n,"default",{value:e,enumerable:!0}):n,e));var ne=B((Ne,te)=>{"use strict";te.exports=function(e){return!e||e.length<3?!1:e[0]===73&&e[1]===68&&e[2]===51||e[0]===255&&(e[1]===251||e[1]===250)}});var oe=B((Ve,re)=>{"use strict";re.exports=function(e){return!e||e.length<12?!1:e[0]===82&&e[1]===73&&e[2]===70&&e[3]===70&&e[8]===87&&e[9]===65&&e[10]===86&&e[11]===69}});var ie=B((Ge,ae)=>{"use strict";ae.exports=function(e){return!e||e.length<4?!1:e[0]===79&&e[1]===103&&e[2]===103&&e[3]===83}});var le=B((Ze,se)=>{"use strict";se.exports=function(e){return!e||e.length<4?!1:e[0]===102&&e[1]===76&&e[2]===97&&e[3]===67}});var ce=B((He,ue)=>{"use strict";ue.exports=function(e){return!e||e.length<8?!1:e[4]===102&&e[5]===116&&e[6]===121&&e[7]===112||e[0]===77&&e[1]===52&&e[2]===65&&e[3]===32}});var he=B((Ye,fe)=>{"use strict";fe.exports=function(e){return e?ne()(e)?"mp3":oe()(e)?"wav":ie()(e)?"oga":le()(e)?"flac":ce()(e)?"m4a":!1:!1}});var Oe=B((exports,module)=>{"use strict";function doEval(self,__pseudoworker_script){(function(){eval(__pseudoworker_script)}).call(global)}function PseudoWorker(e){var t=[],n=[],r=[],o=[],a=[],i=!1,l,m,d=this;function c(f,h){for(var v=-1;++v<f.length;)f[v]&&h(f[v])}function s(f){return function(h){h({type:"error",error:f,message:f.message})}}function w(f,h){f==="message"?t.push(h):f==="error"&&n.push(h)}function u(f,h){var v;if(f==="message")v=t;else if(f==="error")v=n;else return;for(var b=-1;++b<v.length;){var D=v[b];if(D===h){delete v[b];break}}}function p(f){var h=s(f);typeof d.onerror=="function"&&h(d.onerror),m&&typeof m.onerror=="function"&&h(m.onerror),c(n,h),c(o,h)}function y(f,h){function v(b){try{b({data:f,ports:h})}catch(D){p(D)}}m&&typeof m.onmessage=="function"&&v(m.onmessage),c(r,v)}function R(f,h){if(typeof f>"u")throw new Error("postMessage() requires an argument");if(!i){if(!l){a.push({msg:f,transfer:h||void 0});return}y(f,h)}}function C(){i=!0}function k(f){if(i)return;function h(v){v({data:f})}typeof d.onmessage=="function"&&h(d.onmessage),c(t,h)}function U(f,h){f==="message"?r.push(h):f==="error"&&o.push(h)}var A=new XMLHttpRequest;return A.open("GET",e),A.onreadystatechange=function(){if(A.readyState===4)if(A.status>=200&&A.status<400){l=A.responseText,m={postMessage:k,addEventListener:U,close:C},doEval(m,l);var f=a;a=[];for(var h=0;h<f.length;h++)y(f[h].msg,f[h].transfer)}else p(new Error("cannot find script "+e))},A.send(),d.postMessage=R,d.addEventListener=w,d.removeEventListener=u,d.terminate=C,d}module.exports=PseudoWorker});var x=class{constructor(t){if(!t)throw TypeError("options argument is required");if(!t.sampleRate)throw TypeError("options.sampleRate is required");if(t.sampleRate<3e3||t.sampleRate>768e3)throw TypeError("options.sampleRate must be within 3000..768000");if(!t.length)throw TypeError("options.length must be more than 0");this.sampleRate=t.sampleRate,this.numberOfChannels=t.numberOfChannels||1,this.length=t.length|0,this.duration=this.length/this.sampleRate,this._data=new Float32Array(this.length*this.numberOfChannels),this._channelData=[];for(let n=0;n<this.numberOfChannels;n++)this._channelData.push(this._data.subarray(n*this.length,(n+1)*this.length))}getChannelData(t){if(t>=this.numberOfChannels||t<0||t==null)throw Error("Cannot getChannelData: channel number ("+t+") exceeds number of channels ("+this.numberOfChannels+")");return this._channelData[t]}copyFromChannel(t,n,r){r==null&&(r=0);for(var o=this._channelData[n],a=r,i=0;a<this.length&&i<t.length;a++,i++)t[i]=o[a]}copyToChannel(t,n,r){var o=this._channelData[n];r||(r=0);for(var a=r,i=0;a<this.length&&i<t.length;a++,i++)o[a]=t[i]}};var de=ee(he());var N={},Se=async e=>{let t=new Uint8Array(e),n=(0,de.default)(t);return await(await _e(n))(e)},_e=async e=>{if(N[e])return N[e];let t;switch(e){case"mp3":let{MPEGDecoder:n}=await j("mp3");t=new n;break;case"ogg":case"oga":let{OggVorbisDecoder:r}=await j("ogg");t=new r;break;case"flac":let{FLACDecoder:o}=await j("flac");t=new o().decodeFile;break;case"opus":let{OpusDecoder:a}=await j("opus");t=new a().decode;break;case"wav":let{wav:i}=await j("wav");t=i;break;default:throw Error(e?"Unsupported codec "+e:"Unknown codec")}return await t.ready,N[e]=async n=>{console.time("decode");let{channelData:r,sampleRate:o,...a}=t.decodeFile?await t.decodeFile(new Uint8Array(n)):await t.decode(new Uint8Array(n));console.timeEnd("decode");let i=new x({sampleRate:o,length:r[0].length,numberOfChannels:r.length});for(let l=0;l<r.length;l++)i.getChannelData(l).set(r[l]);return i}},j=e=>{console.time("load decoder "+e);let t=import("./decoder/"+e+".js");return console.timeEnd("load decoder "+e),t},I=Se;async function me(e){console.time("fetch");let t=await fetch(e,{cache:"force-cache"});if(console.timeEnd("fetch"),!t.ok)throw new Error(`HTTP error: status=${t.status}`);let n=await t.arrayBuffer();return I(n)}async function V(...e){console.time("wav encode");let t=e[0]?.sampleRate||44100,n=32,r=e[0]?.numberOfChannels||1,o=0;for(let u of e)o+=u.length;let a=new ArrayBuffer(44+o*r*(n>>3)),i=new DataView(a),l=0,m=u=>i.setUint8(l++,u),d=u=>(i.setUint16(l,u,!0),l+=2),c=u=>(i.setUint32(l,u,!0),l+=4),s=u=>{for(var p=0;p<u.length;++p)m(u.charCodeAt(p))};s("RIFF"),c(a.byteLength-8),s("WAVE"),s("fmt "),c(16),d(3),d(r),c(t),c(t*r*(n>>3)),d(r*(n>>3)),d(n),s("data"),c(a.byteLength-44);let w=new Float32Array(a,l);for(let u of e){let p=u.numberOfChannels,y=Array(p),R=u.length;for(let C=0;C<p;++C)y[C]=u.getChannelData(C);for(let C=0;C<R;++C)for(let k=0;k<p;++k)w[l++]=y[k][C]}return console.timeEnd("wav encode"),a}function pe(e){if(!e)return"";if(e._wf)return e._wf;let t=e.getChannelData(0),n="",r=2,o=128,a=1,i=-1;for(let l=0,m=256;l<t.length;){let d=0,c=0;for(;l<m;l++){let y=l>=t.length?0:t[l];c+=y,d+=y**2,a=Math.min(a,y),i=Math.max(i,y)}let s=c/256,w=Math.sqrt(d/256),u=Math.min(100,Math.ceil(w*o*r/(i-a)));n+=String.fromCharCode(256+u);let p=Math.abs(Math.round(s*o/2));n+=(s>0?"\u0301":"\u0300").repeat(p),m+=256}return e._wf=n,n}var ge=e=>new Promise((t,n)=>{let r=new FileReader;r.addEventListener("loadend",o=>{t(o.target.result)}),r.addEventListener("error",n),r.readAsArrayBuffer(e)});var Ce=function(){function e(){}return e.prototype.then=function(t,n){let r=new e,o=this.s;if(o){let a=1&o?t:n;if(a){try{E(r,1,a(this.v))}catch(i){E(r,2,i)}return r}return this}return this.o=function(a){try{let i=a.v;1&a.s?E(r,1,t?t(i):i):n?E(r,1,n(i)):E(r,2,i)}catch(i){E(r,2,i)}},r},e}();function E(e,t,n){if(!e.s){if(n instanceof Ce){if(!n.s)return void(n.o=E.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(E.bind(null,e,t),E.bind(null,e,2));e.s=t,e.v=n;let r=e.o;r&&r(e)}}var je=0,S=typeof WeakMap=="function"?WeakMap:function(){var e=typeof Symbol=="function"?Symbol(0):"__weak$"+ ++je;this.set=function(t,n){t[e]=n},this.get=function(t){return t[e]}};function Y(e,t){return new Promise(function(n,r){e.onsuccess=function(){var o=e.result;t&&(o=t(o)),n(o)},e.onerror=function(){r(e.error)}})}function Ae(e,t){return Y(e.openCursor(t),function(n){return n?[n.key,n.value]:[]})}function ve(e){return new Promise(function(t,n){e.oncomplete=function(){t()},e.onabort=function(){n(e.error)},e.onerror=function(){n(e.error)}})}function G(e){if(!function(t){return!!(typeof t=="number"||typeof t=="string"||typeof t=="object"&&t&&(Array.isArray(t)||"setUTCFullYear"in t||typeof ArrayBuffer=="function"&&ArrayBuffer.isView(t)||"byteLength"in t&&"length"in t))}(e))throw Error("kv-storage: The given value is not allowed as a key")}var be={};function ye(e,t){return Ae(e,Ee(t))}function Ee(e){return e===be?IDBKeyRange.lowerBound(-1/0):IDBKeyRange.lowerBound(e,!0)}var De=new S,W=new S,K=new S,ke=new S,q=function(){};function we(e,t){return t(function(n,r){try{let d=function(){return W.set(e,a),K.set(e,void 0),{value:l,done:a===void 0}};var o=W.get(e);if(o===void 0)return Promise.resolve({value:void 0,done:!0});var a,i,l,m=function(c,s){var w,u=-1;e:{for(var p=0;p<s.length;p++){var y=s[p][0];if(y){var R=y();if(R&&R.then)break e;if(R===c){u=p;break}}else u=p}if(u!==-1){do{for(var C=s[u][1];!C;)C=s[++u][1];var k=C();if(k&&k.then){w=!0;break e}var U=s[u][2];u++}while(U&&!U());return k}}let A=new Ce,f=E.bind(null,A,2);return(w?k.then(h):R.then(function v(b){for(;;){if(b===c){u=p;break}if(++p===s.length){if(u!==-1)break;return void E(A,1,F)}if(y=s[p][0]){if((b=y())&&b.then)return void b.then(v).then(void 0,f)}else u=p}do{for(var D=s[u][1];!D;)D=s[++u][1];var F=D();if(F&&F.then)return void F.then(h).then(void 0,f);var J=s[u][2];u++}while(J&&!J());E(A,1,F)})).then(void 0,f),A;function h(v){for(;;){var b=s[u][2];if(!b||b())break;for(var D=s[++u][1];!D;)D=s[++u][1];if((v=D())&&v.then)return void v.then(h).then(void 0,f)}E(A,1,v)}}(ke.get(e),[[function(){return"keys"},function(){return Promise.resolve(function(c,s){return Ae(c,Ee(s)).then(function(w){return w[0]})}(r,o)).then(function(c){l=a=c})}],[function(){return"values"},function(){return Promise.resolve(ye(r,o)).then(function(c){var s;a=(s=c)[0],l=i=s[1]})}],[function(){return"entries"},function(){return Promise.resolve(ye(r,o)).then(function(c){var s;i=(s=c)[1],l=(a=s[0])===void 0?void 0:[a,i]})}]]);return Promise.resolve(m&&m.then?m.then(d):d())}catch(d){return Promise.reject(d)}})}function Z(e,t){var n=new q;return ke.set(n,e),De.set(n,t),W.set(n,be),K.set(n,void 0),n}q.prototype.return=function(){W.set(this,void 0)},q.prototype.next=function(){var e=this,t=De.get(this);if(!t)return Promise.reject(new TypeError("Invalid this value"));var n,r=K.get(this);return n=r!==void 0?r.then(function(){return we(e,t)}):we(this,t),K.set(this,n),n},typeof Symbol=="function"&&Symbol.asyncIterator&&(q.prototype[Symbol.asyncIterator]=function(){return this});var L=function(e,t,n){try{return P.get(e)===null&&function(r){var o=$.get(r);P.set(r,new Promise(function(a,i){var l=self.indexedDB.open(o,1);l.onsuccess=function(){var m=l.result;(function(d,c,s){if(d.objectStoreNames.length!==1||d.objectStoreNames[0]!==M)return s(H(c)),!1;var w=d.transaction(M,"readonly").objectStore(M);return!(w.autoIncrement||w.keyPath||w.indexNames.length)||(s(H(c)),!1)})(m,o,i)&&(m.onclose=function(){P.set(r,null)},m.onversionchange=function(){m.close(),P.set(r,null)},a(m))},l.onerror=function(){return i(l.error)},l.onupgradeneeded=function(){try{l.result.createObjectStore(M)}catch(m){i(m)}}}))}(e),Promise.resolve(P.get(e)).then(function(r){var o=r.transaction(M,t),a=o.objectStore(M);return n(o,a)})}catch(r){return Promise.reject(r)}},$=new S,P=new S,M="store",O=function(e){var t="kv-storage:"+e;P.set(this,null),$.set(this,t),this.backingStore={database:t,store:M,version:1}};function H(e){return new Error('kv-storage: database "'+e+'" corrupted')}O.prototype.set=function(e,t){try{return G(e),L(this,"readwrite",function(n,r){return t===void 0?r.delete(e):r.put(t,e),ve(n)})}catch(n){return Promise.reject(n)}},O.prototype.get=function(e){try{return G(e),L(this,"readonly",function(t,n){return Y(n.get(e))})}catch(t){return Promise.reject(t)}},O.prototype.delete=function(e){try{return G(e),L(this,"readwrite",function(t,n){return n.delete(e),ve(t)})}catch(t){return Promise.reject(t)}},O.prototype.clear=function(){try{let o=function(){function a(){return Y(self.indexedDB.deleteDatabase($.get(e)))}var i=function(){if(t){try{t.close()}catch{}return Promise.resolve(new Promise(setTimeout)).then(function(){})}}();return i&&i.then?i.then(a):a()};var e=this,t,n=P.get(e),r=function(){if(n!==null){let i=function(){P.set(e,null)};var a=function(l,m){try{var d=Promise.resolve(n).then(function(c){t=c})}catch{return}return d&&d.then?d.then(void 0,function(){}):d}();return a&&a.then?a.then(i):i()}}();return r&&r.then?r.then(o):o()}catch(o){return Promise.reject(o)}},O.prototype.keys=function(){var e=this;return Z("keys",function(t){return L(e,"readonly",t)})},O.prototype.values=function(){var e=this;return Z("values",function(t){return L(e,"readonly",t)})},O.prototype.entries=function(){var e=this;return Z("entries",function(t){return L(e,"readonly",t)})},typeof Symbol=="function"&&Symbol.asyncIterator&&(O.prototype[Symbol.asyncIterator]=O.prototype.entries);var X=new O("default");if(!globalThis.Worker){let{default:e}=await Promise.resolve().then(()=>ee(Oe()));globalThis.Worker=e}self.onmessage=async e=>{let{id:t,ops:n}=e.data,r;for(;t<_.length;)_.pop()();for(let o of n){console.log("Apply op",o);let[a,...i]=o;r=await Ie[a]?.(...i)}Ue(r)};var Ue=async e=>{let t=e.map(i=>pe(i).replaceAll("\u0100"," ")),n=e.reduce((i,{duration:l})=>i+l,0),r=await V(...e),o=new Blob([r],{type:"audio/wav"}),a=URL.createObjectURL(o);self.postMessage({id:_.length,url:a,segments:t,duration:n})},_=[],g=[],Ie={async src(...e){return _.push(()=>g=[]),g=await Promise.all(e.map(me)),g},async file(e){if(typeof e=="string"){let r=await X.get(z+":"+e);if(!r)return g;let o=await ge(r);return g=[await I(o)]}_.push(()=>g.pop());let t=new x({numberOfChannels:e.numberOfChannels,length:e.length,sampleRate:e.sampleRate});e.channelData.forEach((r,o)=>t.getChannelData(o).set(r)),g.push(t);let n=new Blob([await V(...g)]);return console.log("save",z+":"+e.name),X.set(z+":"+e.name,n),g},del(e,t){e=Number(e),t=Number(t);let n=[...g];_.push(()=>{g=n});let r=xe(e),o=xe(t);!o[1]&&o[0]&&(o[0]-=1,o[1]=g[o[0]].length);let a=g[r[0]],i=g[o[0]],l=r[1]+(i.length-o[1]);if(!l)return g=[];let m=new x({length:l,sampleRate:a.sampleRate,numberOfChannels:a.numberOfChannels});for(let c=0;c<a.numberOfChannels;c++){let s=0,w=m.getChannelData(c),u=a.getChannelData(c),p=i.getChannelData(c);for(s=0;s<r[1];s++)w[s]=u[s];for(let y=o[1];y<p.length;y++)w[s]=p[y],s++}let d=g.splice(r[0],o[0]-r[0]+1,m);return g},goto(e){}},xe=e=>{let t=e*256;if(t===0)return[0,0];var n=0,r;for(let o=0;o<g.length;o++){if(r=n+g[o].length,t<r)return[o,t-n];n=r}return[g.length-1,g[g.length-1].length]},z="wavearea-audio";
//# sourceMappingURL=worker.js.map
