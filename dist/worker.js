var W=Object.create;var B=Object.defineProperty;var Y=Object.getOwnPropertyDescriptor;var $=Object.getOwnPropertyNames;var j=Object.getPrototypeOf,z=Object.prototype.hasOwnProperty;var w=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var J=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of $(t))!z.call(e,a)&&a!==n&&B(e,a,{get:()=>t[a],enumerable:!(r=Y(t,a))||r.enumerable});return e};var Q=(e,t,n)=>(n=e!=null?W(j(e)):{},J(t||!e||!e.__esModule?B(n,"default",{value:e,enumerable:!0}):n,e));var _=w((oe,T)=>{"use strict";T.exports=function(e){return!e||e.length<3?!1:e[0]===73&&e[1]===68&&e[2]===51||e[0]===255&&(e[1]===251||e[1]===250)}});var M=w((se,L)=>{"use strict";L.exports=function(e){return!e||e.length<12?!1:e[0]===82&&e[1]===73&&e[2]===70&&e[3]===70&&e[8]===87&&e[9]===65&&e[10]===86&&e[11]===69}});var U=w((he,F)=>{"use strict";F.exports=function(e){return!e||e.length<4?!1:e[0]===79&&e[1]===103&&e[2]===103&&e[3]===83}});var q=w((ie,k)=>{"use strict";k.exports=function(e){return!e||e.length<4?!1:e[0]===102&&e[1]===76&&e[2]===97&&e[3]===67}});var S=w((ce,P)=>{"use strict";P.exports=function(e){return!e||e.length<8?!1:e[4]===102&&e[5]===116&&e[6]===121&&e[7]===112||e[0]===77&&e[1]===52&&e[2]===65&&e[3]===32}});var N=w((ue,K)=>{"use strict";K.exports=function(e){return e?_()(e)?"mp3":M()(e)?"wav":U()(e)?"oga":q()(e)?"flac":S()(e)?"m4a":!1:!1}});var f=class{constructor(t){if(!t)throw TypeError("options argument is required");if(!t.sampleRate)throw TypeError("options.sampleRate is required");if(t.sampleRate<3e3||t.sampleRate>768e3)throw TypeError("options.sampleRate must be within 3000..768000");if(!t.length)throw TypeError("options.length must be more than 0");this.sampleRate=t.sampleRate,this.numberOfChannels=t.numberOfChannels||1,this.length=t.length|0,this.duration=this.length/this.sampleRate,this._data=new Float32Array(this.length*this.numberOfChannels),this._channelData=[];for(let n=0;n<this.numberOfChannels;n++)this._channelData.push(this._data.subarray(n*this.length,(n+1)*this.length))}getChannelData(t){if(t>=this.numberOfChannels||t<0||t==null)throw Error("Cannot getChannelData: channel number ("+t+") exceeds number of channels ("+this.numberOfChannels+")");return this._channelData[t]}copyFromChannel(t,n,r){r==null&&(r=0);for(var a=this._channelData[n],l=r,o=0;l<this.length&&o<t.length;l++,o++)t[o]=a[l]}copyToChannel(t,n,r){var a=this._channelData[n];r||(r=0);for(var l=r,o=0;l<this.length&&o<t.length;l++,o++)a[l]=t[o]}};var V=Q(N());var E={},X=async e=>{let t=new Uint8Array(e),n=(0,V.default)(t);return await(await ee(n))(e)},ee=async e=>{if(E[e])return E[e];let t;switch(e){case"mp3":let{MPEGDecoder:n}=await O("mp3");t=new n;break;case"ogg":case"oga":let{OggVorbisDecoder:r}=await O("ogg");t=new r;break;case"flac":let{FLACDecoder:a}=await O("flac");t=new a().decodeFile;break;case"opus":let{OpusDecoder:l}=await O("opus");t=new l().decode;break;default:throw Error(e?"Unsupported codec "+e:"Unknown codec")}return await t.ready,E[e]=async n=>{console.time("decode");let{channelData:r,sampleRate:a}=t.decodeFile?await t.decodeFile(new Uint8Array(n)):await t.decode(n);console.timeEnd("decode");let l=new f({sampleRate:a,length:r[0].length,numberOfChannels:r.length});for(let o=0;o<r.length;o++)l.getChannelData(o).set(r[o]);return l}},O=e=>{console.time("load decoder "+e);let t=import("./decoder/"+e+".js");return console.timeEnd("load decoder "+e),t},b=X;async function Z(e){console.time("fetch");let t=await fetch(e,{cache:"force-cache"});if(console.timeEnd("fetch"),!t.ok)throw new Error(`HTTP error: status=${t.status}`);let n=await t.arrayBuffer();return b(n)}async function I(...e){console.time("wav encode");let t=e[0]?.sampleRate||44100,n=32,r=e[0]?.numberOfChannels||1,a=0;for(let c of e)a+=c.length;let l=new ArrayBuffer(44+a*r*(n>>3)),o=new DataView(l),u=0,p=c=>o.setUint8(u++,c),h=c=>(o.setUint16(u,c,!0),u+=2),i=c=>(o.setUint32(u,c,!0),u+=4),m=c=>{for(var d=0;d<c.length;++d)p(c.charCodeAt(d))};m("RIFF"),i(l.byteLength-8),m("WAVE"),m("fmt "),i(16),h(3),h(r),i(t),i(t*r*(n>>3)),h(r*(n>>3)),h(n),m("data"),i(l.byteLength-44);let R=new Float32Array(l,u);for(let c of e){let d=c.numberOfChannels,v=Array(d),H=c.length;for(let g=0;g<d;++g)v[g]=c.getChannelData(g);for(let g=0;g<H;++g)for(let x=0;x<d;++x)R[u++]=v[x][g]}return console.timeEnd("wav encode"),l}function G(e){if(!e)return"";if(e._wf)return e._wf;let t=e.getChannelData(0),n="",r=2;for(let a=0,l=1024;a<t.length;){let o=0,u=0;for(;a<l;a++)o+=a>=t.length?0:t[a]**2;let p=Math.sqrt(o/1024),h=Math.min(100,Math.ceil(p*100*r));n+=String.fromCharCode(256+h),l+=1024}return e._wf=n,n}function C(e,t=0,n=e.length){let r=new f({length:n-t,numberOfChannels:e.numberOfChannels,sampleRate:e.sampleRate});for(var a=0;a<r.numberOfChannels;a++)r.copyToChannel(e.getChannelData(a).subarray(t,n),a,0);return r}self.onmessage=async e=>{let{id:t,ops:n}=e.data,r;for(;t<y.length;)y.pop()();for(let h of n){console.log("Apply op",h);let[i,...m]=h;r=await ne[i]?.(...m)}let a=r.map(h=>G(h).replaceAll("\u0100"," ")),l=r.reduce((h,{duration:i})=>h+i,0),o=await I(...r),u=new Blob([o],{type:"audio/wav"}),p=URL.createObjectURL(u);self.postMessage({id:y.length,url:p,segments:a,duration:l})};var y=[],s=[],ne={async src(...e){return y.push(()=>s=[]),s=await Promise.all(e.map(Z)),s},del(e,t){e=Number(e),t=Number(t);let n=[...s];y.push(()=>{s=n});let r=D(e),a=D(t);!a[1]&&a[0]&&(a[0]-=1,a[1]=s[a[0]].length);let l=s[r[0]],o=s[a[0]],u=new f({length:r[1]+(o.length-a[1]),sampleRate:l.sampleRate,numberOfChannels:l.numberOfChannels});for(let h=0;h<l.numberOfChannels;h++){let i=0,m=u.getChannelData(h),R=l.getChannelData(h),c=o.getChannelData(h);for(i=0;i<r[1];i++)m[i]=R[i];for(let d=a[1];d<c.length;d++)m[i]=c[d],i++}let p=s.splice(r[0],a[0]-r[0]+1,u);return s},loop(e,t){e=Number(e),t=Number(t);let n=D(e),r=D(t);return n[0]===r[0]?[C(s[n[0]],n[1],r[1])]:n[0]===r[0]-1?[C(s[n[0]],n[1]),C(s[r[0]],0,r[1])]:[C(s[n[0]],n[1]),...s.slice(n[0]+1,r[0]-1),C(s[r[0]],0,r[1])]},goto(e){}},D=e=>{let t=e*1024;if(t===0)return[0,0];var n=0,r;for(let a=0;a<s.length;a++){if(r=n+s[a].length,t<r)return[a,t-n];n=r}return[s.length-1,s[s.length-1].length]};
//# sourceMappingURL=worker.js.map
