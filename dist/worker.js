var Ee=Object.create;var ee=Object.defineProperty;var Pe=Object.getOwnPropertyDescriptor;var ke=Object.getOwnPropertyNames;var Se=Object.getPrototypeOf,Te=Object.prototype.hasOwnProperty;var E=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var _e=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of ke(t))!Te.call(e,o)&&o!==n&&ee(e,o,{get:()=>t[o],enumerable:!(r=Pe(t,o))||r.enumerable});return e};var Le=(e,t,n)=>(n=e!=null?Ee(Se(e)):{},_e(t||!e||!e.__esModule?ee(n,"default",{value:e,enumerable:!0}):n,e));var ne=E((Ze,te)=>{"use strict";te.exports=function(e){return!e||e.length<3?!1:e[0]===73&&e[1]===68&&e[2]===51||e[0]===255&&(e[1]===251||e[1]===250)}});var oe=E((Ye,re)=>{"use strict";re.exports=function(e){return!e||e.length<12?!1:e[0]===82&&e[1]===73&&e[2]===70&&e[3]===70&&e[8]===87&&e[9]===65&&e[10]===86&&e[11]===69}});var ie=E(($e,ae)=>{"use strict";ae.exports=function(e){return!e||e.length<4?!1:e[0]===79&&e[1]===103&&e[2]===103&&e[3]===83}});var se=E((Ge,le)=>{"use strict";le.exports=function(e){return!e||e.length<4?!1:e[0]===102&&e[1]===76&&e[2]===97&&e[3]===67}});var ce=E((He,ue)=>{"use strict";ue.exports=function(e){return!e||e.length<8?!1:e[4]===102&&e[5]===116&&e[6]===121&&e[7]===112||e[0]===77&&e[1]===52&&e[2]===65&&e[3]===32}});var fe=E((ze,he)=>{"use strict";he.exports=function(e){return e?ne()(e)?"mp3":oe()(e)?"wav":ie()(e)?"oga":se()(e)?"flac":ce()(e)?"m4a":!1:!1}});var w=class{constructor(t){if(!t)throw TypeError("options argument is required");if(!t.sampleRate)throw TypeError("options.sampleRate is required");if(t.sampleRate<3e3||t.sampleRate>768e3)throw TypeError("options.sampleRate must be within 3000..768000");if(!t.length)throw TypeError("options.length must be more than 0");this.sampleRate=t.sampleRate,this.numberOfChannels=t.numberOfChannels||1,this.length=t.length|0,this.duration=this.length/this.sampleRate,this._data=new Float32Array(this.length*this.numberOfChannels),this._channelData=[];for(let n=0;n<this.numberOfChannels;n++)this._channelData.push(this._data.subarray(n*this.length,(n+1)*this.length))}getChannelData(t){if(t>=this.numberOfChannels||t<0||t==null)throw Error("Cannot getChannelData: channel number ("+t+") exceeds number of channels ("+this.numberOfChannels+")");return this._channelData[t]}copyFromChannel(t,n,r){r==null&&(r=0);for(var o=this._channelData[n],a=r,i=0;a<this.length&&i<t.length;a++,i++)t[i]=o[a]}copyToChannel(t,n,r){var o=this._channelData[n];r||(r=0);for(var a=r,i=0;a<this.length&&i<t.length;a++,i++)o[a]=t[i]}};var de=Le(fe());var V={},Me=async e=>{let t=new Uint8Array(e),n=(0,de.default)(t);return await(await je(n))(e)},je=async e=>{if(V[e])return V[e];let t;switch(e){case"mp3":let{MPEGDecoder:n}=await M("mp3");t=new n;break;case"ogg":case"oga":let{OggVorbisDecoder:r}=await M("ogg");t=new r;break;case"flac":let{FLACDecoder:o}=await M("flac");t=new o().decodeFile;break;case"opus":let{OpusDecoder:a}=await M("opus");t=new a().decode;break;case"wav":let{wav:i}=await M("wav");t=i;break;default:throw Error(e?"Unsupported codec "+e:"Unknown codec")}return await t.ready,V[e]=async n=>{console.time("decode");let{channelData:r,sampleRate:o,...a}=t.decodeFile?await t.decodeFile(new Uint8Array(n)):await t.decode(new Uint8Array(n));console.timeEnd("decode");let i=new w({sampleRate:o,length:r[0].length,numberOfChannels:r.length});for(let u=0;u<r.length;u++)i.getChannelData(u).set(r[u]);return i}},M=e=>{console.time("load decoder "+e);let t=import("./decoder/"+e+".js");return console.timeEnd("load decoder "+e),t},W=Me;var ve=function(){function e(){}return e.prototype.then=function(t,n){let r=new e,o=this.s;if(o){let a=1&o?t:n;if(a){try{g(r,1,a(this.v))}catch(i){g(r,2,i)}return r}return this}return this.o=function(a){try{let i=a.v;1&a.s?g(r,1,t?t(i):i):n?g(r,1,n(i)):g(r,2,i)}catch(i){g(r,2,i)}},r},e}();function g(e,t,n){if(!e.s){if(n instanceof ve){if(!n.s)return void(n.o=g.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(g.bind(null,e,t),g.bind(null,e,2));e.s=t,e.v=n;let r=e.o;r&&r(e)}}var Ue=0,k=typeof WeakMap=="function"?WeakMap:function(){var e=typeof Symbol=="function"?Symbol(0):"__weak$"+ ++Ue;this.set=function(t,n){t[e]=n},this.get=function(t){return t[e]}};function G(e,t){return new Promise(function(n,r){e.onsuccess=function(){var o=e.result;t&&(o=t(o)),n(o)},e.onerror=function(){r(e.error)}})}function ye(e,t){return G(e.openCursor(t),function(n){return n?[n.key,n.value]:[]})}function me(e){return new Promise(function(t,n){e.oncomplete=function(){t()},e.onabort=function(){n(e.error)},e.onerror=function(){n(e.error)}})}function Z(e){if(!function(t){return!!(typeof t=="number"||typeof t=="string"||typeof t=="object"&&t&&(Array.isArray(t)||"setUTCFullYear"in t||typeof ArrayBuffer=="function"&&ArrayBuffer.isView(t)||"byteLength"in t&&"length"in t))}(e))throw Error("kv-storage: The given value is not allowed as a key")}var we={};function pe(e,t){return ye(e,Ce(t))}function Ce(e){return e===we?IDBKeyRange.lowerBound(-1/0):IDBKeyRange.lowerBound(e,!0)}var Ae=new k,I=new k,q=new k,be=new k,F=function(){};function ge(e,t){return t(function(n,r){try{let f=function(){return I.set(e,a),q.set(e,void 0),{value:u,done:a===void 0}};var o=I.get(e);if(o===void 0)return Promise.resolve({value:void 0,done:!0});var a,i,u,m=function(c,l){var p,s=-1;e:{for(var d=0;d<l.length;d++){var y=l[d][0];if(y){var x=y();if(x&&x.then)break e;if(x===c){s=d;break}}else s=d}if(s!==-1){do{for(var v=l[s][1];!v;)v=l[++s][1];var A=v();if(A&&A.then){p=!0;break e}var Q=l[s][2];s++}while(Q&&!Q());return A}}let _=new ve,U=g.bind(null,_,2);return(p?A.then(K):x.then(function B(D){for(;;){if(D===c){s=d;break}if(++d===l.length){if(s!==-1)break;return void g(_,1,L)}if(y=l[d][0]){if((D=y())&&D.then)return void D.then(B).then(void 0,U)}else s=d}do{for(var O=l[s][1];!O;)O=l[++s][1];var L=O();if(L&&L.then)return void L.then(K).then(void 0,U);var X=l[s][2];s++}while(X&&!X());g(_,1,L)})).then(void 0,U),_;function K(B){for(;;){var D=l[s][2];if(!D||D())break;for(var O=l[++s][1];!O;)O=l[++s][1];if((B=O())&&B.then)return void B.then(K).then(void 0,U)}g(_,1,B)}}(be.get(e),[[function(){return"keys"},function(){return Promise.resolve(function(c,l){return ye(c,Ce(l)).then(function(p){return p[0]})}(r,o)).then(function(c){u=a=c})}],[function(){return"values"},function(){return Promise.resolve(pe(r,o)).then(function(c){var l;a=(l=c)[0],u=i=l[1]})}],[function(){return"entries"},function(){return Promise.resolve(pe(r,o)).then(function(c){var l;i=(l=c)[1],u=(a=l[0])===void 0?void 0:[a,i]})}]]);return Promise.resolve(m&&m.then?m.then(f):f())}catch(f){return Promise.reject(f)}})}function Y(e,t){var n=new F;return be.set(n,e),Ae.set(n,t),I.set(n,we),q.set(n,void 0),n}F.prototype.return=function(){I.set(this,void 0)},F.prototype.next=function(){var e=this,t=Ae.get(this);if(!t)return Promise.reject(new TypeError("Invalid this value"));var n,r=q.get(this);return n=r!==void 0?r.then(function(){return ge(e,t)}):ge(this,t),q.set(this,n),n},typeof Symbol=="function"&&Symbol.asyncIterator&&(F.prototype[Symbol.asyncIterator]=function(){return this});var P=function(e,t,n){try{return b.get(e)===null&&function(r){var o=H.get(r);b.set(r,new Promise(function(a,i){var u=self.indexedDB.open(o,1);u.onsuccess=function(){var m=u.result;(function(f,c,l){if(f.objectStoreNames.length!==1||f.objectStoreNames[0]!==R)return l($(c)),!1;var p=f.transaction(R,"readonly").objectStore(R);return!(p.autoIncrement||p.keyPath||p.indexNames.length)||(l($(c)),!1)})(m,o,i)&&(m.onclose=function(){b.set(r,null)},m.onversionchange=function(){m.close(),b.set(r,null)},a(m))},u.onerror=function(){return i(u.error)},u.onupgradeneeded=function(){try{u.result.createObjectStore(R)}catch(m){i(m)}}}))}(e),Promise.resolve(b.get(e)).then(function(r){var o=r.transaction(R,t),a=o.objectStore(R);return n(o,a)})}catch(r){return Promise.reject(r)}},H=new k,b=new k,R="store",C=function(e){var t="kv-storage:"+e;b.set(this,null),H.set(this,t),this.backingStore={database:t,store:R,version:1}};function $(e){return new Error('kv-storage: database "'+e+'" corrupted')}C.prototype.set=function(e,t){try{return Z(e),P(this,"readwrite",function(n,r){return t===void 0?r.delete(e):r.put(t,e),me(n)})}catch(n){return Promise.reject(n)}},C.prototype.get=function(e){try{return Z(e),P(this,"readonly",function(t,n){return G(n.get(e))})}catch(t){return Promise.reject(t)}},C.prototype.delete=function(e){try{return Z(e),P(this,"readwrite",function(t,n){return n.delete(e),me(t)})}catch(t){return Promise.reject(t)}},C.prototype.clear=function(){try{let o=function(){function a(){return G(self.indexedDB.deleteDatabase(H.get(e)))}var i=function(){if(t){try{t.close()}catch{}return Promise.resolve(new Promise(setTimeout)).then(function(){})}}();return i&&i.then?i.then(a):a()};var e=this,t,n=b.get(e),r=function(){if(n!==null){let i=function(){b.set(e,null)};var a=function(u,m){try{var f=Promise.resolve(n).then(function(c){t=c})}catch{return}return f&&f.then?f.then(void 0,function(){}):f}();return a&&a.then?a.then(i):i()}}();return r&&r.then?r.then(o):o()}catch(o){return Promise.reject(o)}},C.prototype.keys=function(){var e=this;return Y("keys",function(t){return P(e,"readonly",t)})},C.prototype.values=function(){var e=this;return Y("values",function(t){return P(e,"readonly",t)})},C.prototype.entries=function(){var e=this;return Y("entries",function(t){return P(e,"readonly",t)})},typeof Symbol=="function"&&Symbol.asyncIterator&&(C.prototype[Symbol.asyncIterator]=C.prototype.entries);var z=new C("default");async function De(e){console.time("fetch");let t=await fetch(e,{cache:"force-cache"});if(console.timeEnd("fetch"),!t.ok)throw new Error(`HTTP error: status=${t.status}`);let n=await t.arrayBuffer();return W(n)}async function J(...e){console.time("wav encode");let t=e[0]?.sampleRate||44100,n=32,r=e[0]?.numberOfChannels||1,o=0;for(let s of e)o+=s.length;let a=new ArrayBuffer(44+o*r*(n>>3)),i=new DataView(a),u=0,m=s=>i.setUint8(u++,s),f=s=>(i.setUint16(u,s,!0),u+=2),c=s=>(i.setUint32(u,s,!0),u+=4),l=s=>{for(var d=0;d<s.length;++d)m(s.charCodeAt(d))};l("RIFF"),c(a.byteLength-8),l("WAVE"),l("fmt "),c(16),f(3),f(r),c(t),c(t*r*(n>>3)),f(r*(n>>3)),f(n),l("data"),c(a.byteLength-44);let p=new Float32Array(a,u);for(let s of e){let d=s.numberOfChannels,y=Array(d),x=s.length;for(let v=0;v<d;++v)y[v]=s.getChannelData(v);for(let v=0;v<x;++v)for(let A=0;A<d;++A)p[u++]=y[A][v]}return console.timeEnd("wav encode"),a}function Oe(e){if(!e)return"";if(e._wf)return e._wf;let t=e.getChannelData(0),n="",r=2;for(let o=0,a=1024;o<t.length;){let i=0,u=0;for(;o<a;o++)i+=o>=t.length?0:t[o]**2;let m=Math.sqrt(i/1024),f=Math.min(100,Math.ceil(m*100*r));n+=String.fromCharCode(256+f),a+=1024}return e._wf=n,n}function S(e,t=0,n=e.length){let r=new w({length:n-t,numberOfChannels:e.numberOfChannels,sampleRate:e.sampleRate});for(var o=0;o<r.numberOfChannels;o++)r.copyToChannel(e.getChannelData(o).subarray(t,n),o,0);return r}async function Re(){let e=await z.get(xe);if(!e)return;let t=await Ie(e);return await W(t)}var xe="wavearea-audio";async function Be(...e){let t=new Blob([await J(...e)]);return z.set(xe,t)}var Ie=e=>new Promise((t,n)=>{let r=new FileReader;r.addEventListener("loadend",o=>{t(o.target.result)}),r.addEventListener("error",n),r.readAsArrayBuffer(e)});self.onmessage=async e=>{let{id:t,ops:n}=e.data,r;for(;t<T.length;)T.pop()();for(let o of n){console.log("Apply op",o);let[a,...i]=o;r=await Ne[a]?.(...i)}qe(r)};var qe=async e=>{let t=e.map(i=>Oe(i).replaceAll("\u0100"," ")),n=e.reduce((i,{duration:u})=>i+u,0),r=await J(...e),o=new Blob([r],{type:"audio/wav"}),a=URL.createObjectURL(o);self.postMessage({id:T.length,url:a,segments:t,duration:n})},T=[],h=[],Ne={async src(...e){return T.push(()=>h=[]),h=await Promise.all(e.map(De)),h},async file(e){T.push(()=>h.pop());let t=new w({numberOfChannels:e.numberOfChannels,length:e.length,sampleRate:e.sampleRate});return e.channelData.forEach((n,r)=>t.getChannelData(r).set(n)),h.push(t),Be(...h),h},async load(){let e=await Re();return e?h=[e]:[]},del(e,t){e=Number(e),t=Number(t);let n=[...h];T.push(()=>{h=n});let r=N(e),o=N(t);!o[1]&&o[0]&&(o[0]-=1,o[1]=h[o[0]].length);let a=h[r[0]],i=h[o[0]],u=r[1]+(i.length-o[1]);if(!u)return h=[];let m=new w({length:u,sampleRate:a.sampleRate,numberOfChannels:a.numberOfChannels});for(let c=0;c<a.numberOfChannels;c++){let l=0,p=m.getChannelData(c),s=a.getChannelData(c),d=i.getChannelData(c);for(l=0;l<r[1];l++)p[l]=s[l];for(let y=o[1];y<d.length;y++)p[l]=d[y],l++}let f=h.splice(r[0],o[0]-r[0]+1,m);return h},loop(e,t){e=Number(e),t=Number(t);let n=N(e),r=N(t);return n[0]===r[0]?[S(h[n[0]],n[1],r[1])]:n[0]===r[0]-1?[S(h[n[0]],n[1]),S(h[r[0]],0,r[1])]:[S(h[n[0]],n[1]),...h.slice(n[0]+1,r[0]-1),S(h[r[0]],0,r[1])]},goto(e){}},N=e=>{let t=e*1024;if(t===0)return[0,0];var n=0,r;for(let o=0;o<h.length;o++){if(r=n+h[o].length,t<r)return[o,t-n];n=r}return[h.length-1,h[h.length-1].length]};
//# sourceMappingURL=worker.js.map
