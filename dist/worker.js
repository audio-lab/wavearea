var xe=Object.create;var X=Object.defineProperty;var Be=Object.getOwnPropertyDescriptor;var Ee=Object.getOwnPropertyNames;var Pe=Object.getPrototypeOf,ke=Object.prototype.hasOwnProperty;var E=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var Se=(e,t,n,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of Ee(t))!ke.call(e,o)&&o!==n&&X(e,o,{get:()=>t[o],enumerable:!(r=Be(t,o))||r.enumerable});return e};var Te=(e,t,n)=>(n=e!=null?xe(Pe(e)):{},Se(t||!e||!e.__esModule?X(n,"default",{value:e,enumerable:!0}):n,e));var te=E((Ne,ee)=>{"use strict";ee.exports=function(e){return!e||e.length<3?!1:e[0]===73&&e[1]===68&&e[2]===51||e[0]===255&&(e[1]===251||e[1]===250)}});var re=E((Ve,ne)=>{"use strict";ne.exports=function(e){return!e||e.length<12?!1:e[0]===82&&e[1]===73&&e[2]===70&&e[3]===70&&e[8]===87&&e[9]===65&&e[10]===86&&e[11]===69}});var ae=E((We,oe)=>{"use strict";oe.exports=function(e){return!e||e.length<4?!1:e[0]===79&&e[1]===103&&e[2]===103&&e[3]===83}});var le=E((Ze,ie)=>{"use strict";ie.exports=function(e){return!e||e.length<4?!1:e[0]===102&&e[1]===76&&e[2]===97&&e[3]===67}});var ue=E((Ye,se)=>{"use strict";se.exports=function(e){return!e||e.length<8?!1:e[4]===102&&e[5]===116&&e[6]===121&&e[7]===112||e[0]===77&&e[1]===52&&e[2]===65&&e[3]===32}});var he=E(($e,ce)=>{"use strict";ce.exports=function(e){return e?te()(e)?"mp3":re()(e)?"wav":ae()(e)?"oga":le()(e)?"flac":ue()(e)?"m4a":!1:!1}});var C=class{constructor(t){if(!t)throw TypeError("options argument is required");if(!t.sampleRate)throw TypeError("options.sampleRate is required");if(t.sampleRate<3e3||t.sampleRate>768e3)throw TypeError("options.sampleRate must be within 3000..768000");if(!t.length)throw TypeError("options.length must be more than 0");this.sampleRate=t.sampleRate,this.numberOfChannels=t.numberOfChannels||1,this.length=t.length|0,this.duration=this.length/this.sampleRate,this._data=new Float32Array(this.length*this.numberOfChannels),this._channelData=[];for(let n=0;n<this.numberOfChannels;n++)this._channelData.push(this._data.subarray(n*this.length,(n+1)*this.length))}getChannelData(t){if(t>=this.numberOfChannels||t<0||t==null)throw Error("Cannot getChannelData: channel number ("+t+") exceeds number of channels ("+this.numberOfChannels+")");return this._channelData[t]}copyFromChannel(t,n,r){r==null&&(r=0);for(var o=this._channelData[n],a=r,i=0;a<this.length&&i<t.length;a++,i++)t[i]=o[a]}copyToChannel(t,n,r){var o=this._channelData[n];r||(r=0);for(var a=r,i=0;a<this.length&&i<t.length;a++,i++)o[a]=t[i]}};var fe=Te(he());var N={},_e=async e=>{let t=new Uint8Array(e),n=(0,fe.default)(t);return await(await Le(n))(e)},Le=async e=>{if(N[e])return N[e];let t;switch(e){case"mp3":let{MPEGDecoder:n}=await L("mp3");t=new n;break;case"ogg":case"oga":let{OggVorbisDecoder:r}=await L("ogg");t=new r;break;case"flac":let{FLACDecoder:o}=await L("flac");t=new o().decodeFile;break;case"opus":let{OpusDecoder:a}=await L("opus");t=new a().decode;break;case"wav":let{wav:i}=await L("wav");t=i;break;default:throw Error(e?"Unsupported codec "+e:"Unknown codec")}return await t.ready,N[e]=async n=>{console.time("decode");let{channelData:r,sampleRate:o,...a}=t.decodeFile?await t.decodeFile(new Uint8Array(n)):await t.decode(new Uint8Array(n));console.timeEnd("decode");let i=new C({sampleRate:o,length:r[0].length,numberOfChannels:r.length});for(let u=0;u<r.length;u++)i.getChannelData(u).set(r[u]);return i}},L=e=>{console.time("load decoder "+e);let t=import("./decoder/"+e+".js");return console.timeEnd("load decoder "+e),t},U=_e;async function de(e){console.time("fetch");let t=await fetch(e,{cache:"force-cache"});if(console.timeEnd("fetch"),!t.ok)throw new Error(`HTTP error: status=${t.status}`);let n=await t.arrayBuffer();return U(n)}async function V(...e){console.time("wav encode");let t=e[0]?.sampleRate||44100,n=32,r=e[0]?.numberOfChannels||1,o=0;for(let s of e)o+=s.length;let a=new ArrayBuffer(44+o*r*(n>>3)),i=new DataView(a),u=0,m=s=>i.setUint8(u++,s),f=s=>(i.setUint16(u,s,!0),u+=2),c=s=>(i.setUint32(u,s,!0),u+=4),l=s=>{for(var d=0;d<s.length;++d)m(s.charCodeAt(d))};l("RIFF"),c(a.byteLength-8),l("WAVE"),l("fmt "),c(16),f(3),f(r),c(t),c(t*r*(n>>3)),f(r*(n>>3)),f(n),l("data"),c(a.byteLength-44);let p=new Float32Array(a,u);for(let s of e){let d=s.numberOfChannels,y=Array(d),x=s.length;for(let v=0;v<d;++v)y[v]=s.getChannelData(v);for(let v=0;v<x;++v)for(let A=0;A<d;++A)p[u++]=y[A][v]}return console.timeEnd("wav encode"),a}function me(e){if(!e)return"";if(e._wf)return e._wf;let t=e.getChannelData(0),n="",r=2;for(let o=0,a=1024;o<t.length;){let i=0,u=0;for(;o<a;o++)i+=o>=t.length?0:t[o]**2;let m=Math.sqrt(i/1024),f=Math.min(100,Math.ceil(m*100*r));n+=String.fromCharCode(256+f),a+=1024}return e._wf=n,n}var pe=e=>new Promise((t,n)=>{let r=new FileReader;r.addEventListener("loadend",o=>{t(o.target.result)}),r.addEventListener("error",n),r.readAsArrayBuffer(e)});var we=function(){function e(){}return e.prototype.then=function(t,n){let r=new e,o=this.s;if(o){let a=1&o?t:n;if(a){try{g(r,1,a(this.v))}catch(i){g(r,2,i)}return r}return this}return this.o=function(a){try{let i=a.v;1&a.s?g(r,1,t?t(i):i):n?g(r,1,n(i)):g(r,2,i)}catch(i){g(r,2,i)}},r},e}();function g(e,t,n){if(!e.s){if(n instanceof we){if(!n.s)return void(n.o=g.bind(null,e,t));1&t&&(t=n.s),n=n.v}if(n&&n.then)return void n.then(g.bind(null,e,t),g.bind(null,e,2));e.s=t,e.v=n;let r=e.o;r&&r(e)}}var je=0,k=typeof WeakMap=="function"?WeakMap:function(){var e=typeof Symbol=="function"?Symbol(0):"__weak$"+ ++je;this.set=function(t,n){t[e]=n},this.get=function(t){return t[e]}};function $(e,t){return new Promise(function(n,r){e.onsuccess=function(){var o=e.result;t&&(o=t(o)),n(o)},e.onerror=function(){r(e.error)}})}function Ce(e,t){return $(e.openCursor(t),function(n){return n?[n.key,n.value]:[]})}function ge(e){return new Promise(function(t,n){e.oncomplete=function(){t()},e.onabort=function(){n(e.error)},e.onerror=function(){n(e.error)}})}function W(e){if(!function(t){return!!(typeof t=="number"||typeof t=="string"||typeof t=="object"&&t&&(Array.isArray(t)||"setUTCFullYear"in t||typeof ArrayBuffer=="function"&&ArrayBuffer.isView(t)||"byteLength"in t&&"length"in t))}(e))throw Error("kv-storage: The given value is not allowed as a key")}var Ae={};function ve(e,t){return Ce(e,De(t))}function De(e){return e===Ae?IDBKeyRange.lowerBound(-1/0):IDBKeyRange.lowerBound(e,!0)}var be=new k,I=new k,q=new k,Oe=new k,F=function(){};function ye(e,t){return t(function(n,r){try{let f=function(){return I.set(e,a),q.set(e,void 0),{value:u,done:a===void 0}};var o=I.get(e);if(o===void 0)return Promise.resolve({value:void 0,done:!0});var a,i,u,m=function(c,l){var p,s=-1;e:{for(var d=0;d<l.length;d++){var y=l[d][0];if(y){var x=y();if(x&&x.then)break e;if(x===c){s=d;break}}else s=d}if(s!==-1){do{for(var v=l[s][1];!v;)v=l[++s][1];var A=v();if(A&&A.then){p=!0;break e}var J=l[s][2];s++}while(J&&!J());return A}}let T=new we,j=g.bind(null,T,2);return(p?A.then(K):x.then(function B(b){for(;;){if(b===c){s=d;break}if(++d===l.length){if(s!==-1)break;return void g(T,1,_)}if(y=l[d][0]){if((b=y())&&b.then)return void b.then(B).then(void 0,j)}else s=d}do{for(var O=l[s][1];!O;)O=l[++s][1];var _=O();if(_&&_.then)return void _.then(K).then(void 0,j);var Q=l[s][2];s++}while(Q&&!Q());g(T,1,_)})).then(void 0,j),T;function K(B){for(;;){var b=l[s][2];if(!b||b())break;for(var O=l[++s][1];!O;)O=l[++s][1];if((B=O())&&B.then)return void B.then(K).then(void 0,j)}g(T,1,B)}}(Oe.get(e),[[function(){return"keys"},function(){return Promise.resolve(function(c,l){return Ce(c,De(l)).then(function(p){return p[0]})}(r,o)).then(function(c){u=a=c})}],[function(){return"values"},function(){return Promise.resolve(ve(r,o)).then(function(c){var l;a=(l=c)[0],u=i=l[1]})}],[function(){return"entries"},function(){return Promise.resolve(ve(r,o)).then(function(c){var l;i=(l=c)[1],u=(a=l[0])===void 0?void 0:[a,i]})}]]);return Promise.resolve(m&&m.then?m.then(f):f())}catch(f){return Promise.reject(f)}})}function Z(e,t){var n=new F;return Oe.set(n,e),be.set(n,t),I.set(n,Ae),q.set(n,void 0),n}F.prototype.return=function(){I.set(this,void 0)},F.prototype.next=function(){var e=this,t=be.get(this);if(!t)return Promise.reject(new TypeError("Invalid this value"));var n,r=q.get(this);return n=r!==void 0?r.then(function(){return ye(e,t)}):ye(this,t),q.set(this,n),n},typeof Symbol=="function"&&Symbol.asyncIterator&&(F.prototype[Symbol.asyncIterator]=function(){return this});var P=function(e,t,n){try{return D.get(e)===null&&function(r){var o=G.get(r);D.set(r,new Promise(function(a,i){var u=self.indexedDB.open(o,1);u.onsuccess=function(){var m=u.result;(function(f,c,l){if(f.objectStoreNames.length!==1||f.objectStoreNames[0]!==R)return l(Y(c)),!1;var p=f.transaction(R,"readonly").objectStore(R);return!(p.autoIncrement||p.keyPath||p.indexNames.length)||(l(Y(c)),!1)})(m,o,i)&&(m.onclose=function(){D.set(r,null)},m.onversionchange=function(){m.close(),D.set(r,null)},a(m))},u.onerror=function(){return i(u.error)},u.onupgradeneeded=function(){try{u.result.createObjectStore(R)}catch(m){i(m)}}}))}(e),Promise.resolve(D.get(e)).then(function(r){var o=r.transaction(R,t),a=o.objectStore(R);return n(o,a)})}catch(r){return Promise.reject(r)}},G=new k,D=new k,R="store",w=function(e){var t="kv-storage:"+e;D.set(this,null),G.set(this,t),this.backingStore={database:t,store:R,version:1}};function Y(e){return new Error('kv-storage: database "'+e+'" corrupted')}w.prototype.set=function(e,t){try{return W(e),P(this,"readwrite",function(n,r){return t===void 0?r.delete(e):r.put(t,e),ge(n)})}catch(n){return Promise.reject(n)}},w.prototype.get=function(e){try{return W(e),P(this,"readonly",function(t,n){return $(n.get(e))})}catch(t){return Promise.reject(t)}},w.prototype.delete=function(e){try{return W(e),P(this,"readwrite",function(t,n){return n.delete(e),ge(t)})}catch(t){return Promise.reject(t)}},w.prototype.clear=function(){try{let o=function(){function a(){return $(self.indexedDB.deleteDatabase(G.get(e)))}var i=function(){if(t){try{t.close()}catch{}return Promise.resolve(new Promise(setTimeout)).then(function(){})}}();return i&&i.then?i.then(a):a()};var e=this,t,n=D.get(e),r=function(){if(n!==null){let i=function(){D.set(e,null)};var a=function(u,m){try{var f=Promise.resolve(n).then(function(c){t=c})}catch{return}return f&&f.then?f.then(void 0,function(){}):f}();return a&&a.then?a.then(i):i()}}();return r&&r.then?r.then(o):o()}catch(o){return Promise.reject(o)}},w.prototype.keys=function(){var e=this;return Z("keys",function(t){return P(e,"readonly",t)})},w.prototype.values=function(){var e=this;return Z("values",function(t){return P(e,"readonly",t)})},w.prototype.entries=function(){var e=this;return Z("entries",function(t){return P(e,"readonly",t)})},typeof Symbol=="function"&&Symbol.asyncIterator&&(w.prototype[Symbol.asyncIterator]=w.prototype.entries);var H=new w("default");self.onmessage=async e=>{let{id:t,ops:n}=e.data,r;for(;t<S.length;)S.pop()();for(let o of n){console.log("Apply op",o);let[a,...i]=o;r=await Fe[a]?.(...i)}Ue(r)};var Ue=async e=>{let t=e.map(i=>me(i).replaceAll("\u0100"," ")),n=e.reduce((i,{duration:u})=>i+u,0),r=await V(...e),o=new Blob([r],{type:"audio/wav"}),a=URL.createObjectURL(o);self.postMessage({id:S.length,url:a,segments:t,duration:n})},S=[],h=[],Fe={async src(...e){return S.push(()=>h=[]),h=await Promise.all(e.map(de)),h},async file(e){if(typeof e=="string"){let r=await H.get(z+":"+e);if(!r)return h;let o=await pe(r);return h=[await U(o)]}S.push(()=>h.pop());let t=new C({numberOfChannels:e.numberOfChannels,length:e.length,sampleRate:e.sampleRate});e.channelData.forEach((r,o)=>t.getChannelData(o).set(r)),h.push(t);let n=new Blob([await V(...h)]);return console.log("save",z+":"+e.file.name),H.set(z+":"+e.file.name,n),h},del(e,t){e=Number(e),t=Number(t);let n=[...h];S.push(()=>{h=n});let r=Re(e),o=Re(t);!o[1]&&o[0]&&(o[0]-=1,o[1]=h[o[0]].length);let a=h[r[0]],i=h[o[0]],u=r[1]+(i.length-o[1]);if(!u)return h=[];let m=new C({length:u,sampleRate:a.sampleRate,numberOfChannels:a.numberOfChannels});for(let c=0;c<a.numberOfChannels;c++){let l=0,p=m.getChannelData(c),s=a.getChannelData(c),d=i.getChannelData(c);for(l=0;l<r[1];l++)p[l]=s[l];for(let y=o[1];y<d.length;y++)p[l]=d[y],l++}let f=h.splice(r[0],o[0]-r[0]+1,m);return h},goto(e){}},Re=e=>{let t=e*1024;if(t===0)return[0,0];var n=0,r;for(let o=0;o<h.length;o++){if(r=n+h[o].length,t<r)return[o,t-n];n=r}return[h.length-1,h[h.length-1].length]},z="wavearea-audio";
//# sourceMappingURL=worker.js.map
