var $=Object.create;var B=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var Q=Object.getPrototypeOf,X=Object.prototype.hasOwnProperty;var C=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var ee=(e,t,n,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of J(t))!X.call(e,r)&&r!==n&&B(e,r,{get:()=>t[r],enumerable:!(a=z(t,r))||a.enumerable});return e};var te=(e,t,n)=>(n=e!=null?$(Q(e)):{},ee(t||!e||!e.__esModule?B(n,"default",{value:e,enumerable:!0}):n,e));var T=C((ie,b)=>{"use strict";b.exports=function(e){return!e||e.length<3?!1:e[0]===73&&e[1]===68&&e[2]===51||e[0]===255&&(e[1]===251||e[1]===250)}});var M=C((ue,_)=>{"use strict";_.exports=function(e){return!e||e.length<12?!1:e[0]===82&&e[1]===73&&e[2]===70&&e[3]===70&&e[8]===87&&e[9]===65&&e[10]===86&&e[11]===69}});var F=C((fe,L)=>{"use strict";L.exports=function(e){return!e||e.length<4?!1:e[0]===79&&e[1]===103&&e[2]===103&&e[3]===83}});var k=C((ce,U)=>{"use strict";U.exports=function(e){return!e||e.length<4?!1:e[0]===102&&e[1]===76&&e[2]===97&&e[3]===67}});var S=C((me,q)=>{"use strict";q.exports=function(e){return!e||e.length<8?!1:e[4]===102&&e[5]===116&&e[6]===121&&e[7]===112||e[0]===77&&e[1]===52&&e[2]===65&&e[3]===32}});var I=C((de,P)=>{"use strict";P.exports=function(e){return e?T()(e)?"mp3":M()(e)?"wav":F()(e)?"oga":k()(e)?"flac":S()(e)?"m4a":!1:!1}});var m=class{constructor(t){if(!t)throw TypeError("options argument is required");if(!t.sampleRate)throw TypeError("options.sampleRate is required");if(t.sampleRate<3e3||t.sampleRate>768e3)throw TypeError("options.sampleRate must be within 3000..768000");if(!t.length)throw TypeError("options.length must be more than 0");this.sampleRate=t.sampleRate,this.numberOfChannels=t.numberOfChannels||1,this.length=t.length|0,this.duration=this.length/this.sampleRate,this._data=new Float32Array(this.length*this.numberOfChannels),this._channelData=[];for(let n=0;n<this.numberOfChannels;n++)this._channelData.push(this._data.subarray(n*this.length,(n+1)*this.length))}getChannelData(t){if(t>=this.numberOfChannels||t<0||t==null)throw Error("Cannot getChannelData: channel number ("+t+") exceeds number of channels ("+this.numberOfChannels+")");return this._channelData[t]}copyFromChannel(t,n,a){a==null&&(a=0);for(var r=this._channelData[n],o=a,l=0;o<this.length&&l<t.length;o++,l++)t[l]=r[o]}copyToChannel(t,n,a){var r=this._channelData[n];a||(a=0);for(var o=a,l=0;o<this.length&&l<t.length;o++,l++)r[o]=t[l]}};var K=te(I());var R={},ne=async e=>{let t=new Uint8Array(e),n=(0,K.default)(t);return await(await re(n))(e)},re=async e=>{if(R[e])return R[e];let t;switch(e){case"mp3":let{MPEGDecoder:n}=await y("mp3");t=new n;break;case"ogg":case"oga":let{OggVorbisDecoder:a}=await y("ogg");t=new a;break;case"flac":let{FLACDecoder:r}=await y("flac");t=new r().decodeFile;break;case"opus":let{OpusDecoder:o}=await y("opus");t=new o().decode;break;default:throw Error(e?"Unsupported codec "+e:"Unknown codec")}return await t.ready,R[e]=async n=>{console.time("decode");let{channelData:a,sampleRate:r}=t.decodeFile?await t.decodeFile(new Uint8Array(n)):await t.decode(n);console.timeEnd("decode");let o=new m({sampleRate:r,length:a[0].length,numberOfChannels:a.length});for(let l=0;l<a.length;l++)o.getChannelData(l).set(a[l]);return o}},y=e=>{console.time("load decoder "+e);let t=import("./decoder/"+e+".js");return console.timeEnd("load decoder "+e),t},V=ne;async function Z(e){console.time("fetch");let t=await fetch(e);if(!t.ok)throw new Error(`HTTP error: status=${t.status}`);let n=await t.arrayBuffer();return console.timeEnd("fetch"),V(n)}async function j(...e){console.time("wav encode");let t=e[0]?.sampleRate||44100,n=32,a=e[0]?.numberOfChannels||1,r=0;for(let f of e)r+=f.length;let o=new ArrayBuffer(44+r*a*(n>>3)),l=new DataView(o),i=0,u=f=>l.setUint8(i++,f),s=f=>(l.setUint16(i,f,!0),i+=2),c=f=>(l.setUint32(i,f,!0),i+=4),p=f=>{for(var g=0;g<f.length;++g)u(f.charCodeAt(g))};p("RIFF"),c(o.byteLength-8),p("WAVE"),p("fmt "),c(16),s(3),s(a),c(t),c(t*a*(n>>3)),s(a*(n>>3)),s(n),p("data"),c(o.byteLength-44);let D=new Float32Array(o,i);for(let f of e){let g=f.numberOfChannels,v=Array(g),Y=f.length;for(let d=0;d<g;++d)v[d]=f.getChannelData(d);for(let d=0;d<Y;++d)for(let x=0;x<g;++x)D[i++]=v[x][d]}return console.timeEnd("wav encode"),o}function N(e){if(!e)return"";if(e._wf)return e._wf;console.time("to waveform string");let t=e.getChannelData(0),n="",a=2;for(let r=0,o=1024;r<t.length;){let l=0,i=0;for(;r<o;r++)l+=r>=t.length?0:t[r]**2;let u=Math.sqrt(l/1024),s=Math.min(100,Math.ceil(u*100*a));n+=String.fromCharCode(256+s),o+=1024}return e._wf=n,console.timeEnd("to waveform string"),n}function W(e){let t=new m({sampleRate:e.sampleRate,numberOfChannels:e.numberOfChannels,length:e.length});for(let n=0;n<e.numberOfChannels;n++)t.getChannelData(n).set(e.getChannelData(n));return t}var ae=[],G=0,A=[];self.onmessage=async e=>{A.push(e.data),A.length===1&&H()};var H=async()=>{let e=A[0];console.log("Apply op",e);let[t,...n]=e,a=await le[t]?.(...n);if(ae.push(a),A.shift(),A.length)return H();let r=h.map(s=>N(s).replaceAll("\u0100"," ")),o=h.reduce((s,{duration:c})=>s+c,0),l=await j(...h),i=new Blob([l],{type:"audio/wav"}),u=URL.createObjectURL(i);G++,self.postMessage({id:G,url:u,segments:r,duration:o})},h=[],le={async src(...e){return h=await Promise.all(e.map(Z)),()=>h=[]},norm(){let e=h.map(l=>W(l)),t=0,n=0;for(let l of h)for(let i=0;i<l.numberOfChannels;i++){let u=l.getChannelData(i);n+=u.length;for(let s=0;s<u.length;s++)t+=u[s]}let a=t/n;for(let l of h)for(let i=0;i<l.numberOfChannels;i++){let u=l.getChannelData(i);n+=u.length;for(let s=0;s<u.length;s++)u[s]-=a}let r=0;for(let l of h)for(let i=0;i<l.numberOfChannels;i++){let u=l.getChannelData(i);for(let s=0;s<u.length;s++)r=Math.max(Math.abs(u[s]),r)}let o=Math.max(1/r,1);for(let l of h)for(let i=0;i<l.numberOfChannels;i++){let u=l.getChannelData(i);for(let s=0;s<u.length;s++)u[s]=Math.min(1,Math.max(-1,u[s]*o))}return()=>e},br(e,...t){for(let n of t){let[a,r]=O(n),o=e[a];if(r>0&&r<o.length){let l=sliceAudio(o,0,r),i=sliceAudio(o,r);e.splice(a,1,l,i)}}return e},join(e){let[t,n]=O(e);if(n)return console.warn("Wrong buffer offset",e);let a=h[t-1],r=h[t];return h.splice(t-1,2,joinAudio(a,r)),h},del(e,t){if(e=Number(e),t=Number(t),!t)return h;let n=O(e),a=O(e+t);!a[1]&&a[0]&&(a[0]-=1,a[1]=h[a[0]].length);let r=h[n[0]],o=h[a[0]],l=new m({length:n[1]+(o.length-a[1]),sampleRate:r.sampleRate,numberOfChannels:r.numberOfChannels});for(let u=0;u<r.numberOfChannels;u++){let s=0,c=l.getChannelData(u),p=r.getChannelData(u),D=o.getChannelData(u);for(s=0;s<n[1];s++)c[s]=p[s];for(let f=a[1];f<D.length;f++)c[s]=D[f],s++}let i=h.splice(n[0],a[0]-n[0]+1,l);return()=>{}},mute(...e){for(let t of e){let[n,a]=t,[r,o]=O(n);!o&&r&&(r-=1,o=h[r].length);let l=new m({length:a*1024,numberOfChannels:h?.[0].numberOfChannels||1,sampleRate:h?.[0].sampleRate||44100});h[r]=insertAudio(h[r],o,l)}return h},clip(e,t){},add(e,t){},cp(e,t,n){},undo(){}},O=e=>{let t=e*1024;if(t===0)return[0,0];var n=0,a;for(let r=0;r<h.length;r++){if(a=n+h[r].length,t<a)return[r,t-n];n=a}return[h.length-1,h[h.length-1].length]};
//# sourceMappingURL=worker.js.map
