var $=Object.create;var B=Object.defineProperty;var z=Object.getOwnPropertyDescriptor;var J=Object.getOwnPropertyNames;var Q=Object.getPrototypeOf,X=Object.prototype.hasOwnProperty;var C=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var ee=(e,t,n,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of J(t))!X.call(e,r)&&r!==n&&B(e,r,{get:()=>t[r],enumerable:!(a=z(t,r))||a.enumerable});return e};var te=(e,t,n)=>(n=e!=null?$(Q(e)):{},ee(t||!e||!e.__esModule?B(n,"default",{value:e,enumerable:!0}):n,e));var T=C((ie,b)=>{"use strict";b.exports=function(e){return!e||e.length<3?!1:e[0]===73&&e[1]===68&&e[2]===51||e[0]===255&&(e[1]===251||e[1]===250)}});var M=C((ue,_)=>{"use strict";_.exports=function(e){return!e||e.length<12?!1:e[0]===82&&e[1]===73&&e[2]===70&&e[3]===70&&e[8]===87&&e[9]===65&&e[10]===86&&e[11]===69}});var k=C((fe,L)=>{"use strict";L.exports=function(e){return!e||e.length<4?!1:e[0]===79&&e[1]===103&&e[2]===103&&e[3]===83}});var S=C((ce,q)=>{"use strict";q.exports=function(e){return!e||e.length<4?!1:e[0]===102&&e[1]===76&&e[2]===97&&e[3]===67}});var P=C((me,U)=>{"use strict";U.exports=function(e){return!e||e.length<8?!1:e[4]===102&&e[5]===116&&e[6]===121&&e[7]===112||e[0]===77&&e[1]===52&&e[2]===65&&e[3]===32}});var I=C((ge,F)=>{"use strict";F.exports=function(e){return e?T()(e)?"mp3":M()(e)?"wav":k()(e)?"oga":S()(e)?"flac":P()(e)?"m4a":!1:!1}});var m=class{constructor(t){if(!t)throw TypeError("options argument is required");if(!t.sampleRate)throw TypeError("options.sampleRate is required");if(t.sampleRate<3e3||t.sampleRate>768e3)throw TypeError("options.sampleRate must be within 3000..768000");if(!t.length)throw TypeError("options.length must be more than 0");this.sampleRate=t.sampleRate,this.numberOfChannels=t.numberOfChannels||1,this.length=t.length|0,this.duration=this.length/this.sampleRate,this._data=new Float32Array(this.length*this.numberOfChannels),this._channelData=[];for(let n=0;n<this.numberOfChannels;n++)this._channelData.push(this._data.subarray(n*this.length,(n+1)*this.length))}getChannelData(t){if(t>=this.numberOfChannels||t<0||t==null)throw Error("Cannot getChannelData: channel number ("+t+") exceeds number of channels ("+this.numberOfChannels+")");return this._channelData[t]}copyFromChannel(t,n,a){a==null&&(a=0);for(var r=this._channelData[n],s=a,l=0;s<this.length&&l<t.length;s++,l++)t[l]=r[s]}copyToChannel(t,n,a){var r=this._channelData[n];a||(a=0);for(var s=a,l=0;s<this.length&&l<t.length;s++,l++)r[s]=t[l]}};var K=te(I());var R={},ne=async e=>{let t=new Uint8Array(e),n=(0,K.default)(t),a=await re(n);console.time("decode");let r=await a(e);return console.timeEnd("decode"),r},re=async e=>{if(R[e])return R[e];let t;switch(e){case"mp3":let{MPEGDecoder:n}=await y("mp3");t=new n;break;case"ogg":case"oga":let{OGGDecoder:a}=await y("ogg");t=new a;break;case"flac":let{FLACDecoder:r}=await y("flac");t=new r;break;case"opus":let{OpusDecoder:s}=await y("opus");t=new s;break;default:throw Error(e?"Unsupported codec "+e:"Unknown codec")}return await t.ready,R[e]=async n=>{let{channelData:a,sampleRate:r,...s}=await t.decode(n),l=new m({sampleRate:r,length:a[0].length,numberOfChannels:a.length});for(let h=0;h<a.length;h++)l.getChannelData(h).set(a[h]);return l}},y=e=>{console.time("load decoder "+e);let t=import("./decoder/"+e+".js");return console.timeEnd("load decoder "+e),t},G=ne;async function V(e){console.time("fetch");let t=await fetch(e);if(!t.ok)throw new Error(`HTTP error: status=${t.status}`);let n=await t.arrayBuffer();return console.timeEnd("fetch"),G(n)}async function Z(...e){console.time("wav encode");let t=e[0]?.sampleRate||44100,n=32,a=e[0]?.numberOfChannels||1,r=0;for(let f of e)r+=f.length;let s=new ArrayBuffer(44+r*a*(n>>3)),l=new DataView(s),h=0,u=f=>l.setUint8(h++,f),o=f=>(l.setUint16(h,f,!0),h+=2),c=f=>(l.setUint32(h,f,!0),h+=4),p=f=>{for(var d=0;d<f.length;++d)u(f.charCodeAt(d))};p("RIFF"),c(s.byteLength-8),p("WAVE"),p("fmt "),c(16),o(3),o(a),c(t),c(t*a*(n>>3)),o(a*(n>>3)),o(n),p("data"),c(s.byteLength-44);let A=new Float32Array(s,h);for(let f of e){let d=f.numberOfChannels,v=Array(d),Y=f.length;for(let g=0;g<d;++g)v[g]=f.getChannelData(g);for(let g=0;g<Y;++g)for(let x=0;x<d;++x)A[h++]=v[x][g]}return console.timeEnd("wav encode"),s}function j(e){if(!e)return"";if(e._wf)return e._wf;console.time("to waveform string");let t=e.getChannelData(0),n="",a=2;for(let r=0,s=1024;r<t.length;){let l=0,h=0;for(;r<s;r++)l+=r>=t.length?0:t[r]**2;let u=Math.sqrt(l/1024),o=Math.min(100,Math.ceil(u*100*a));n+=String.fromCharCode(256+o),s+=1024}return e._wf=n,console.timeEnd("to waveform string"),n}function N(e){let t=new m({sampleRate:e.sampleRate,numberOfChannels:e.numberOfChannels,length:e.length});for(let n=0;n<e.numberOfChannels;n++)t.getChannelData(n).set(e.getChannelData(n));return t}var ae=[],W=0,D=[];self.onmessage=async e=>{D.push(e.data),D.length===1&&H()};var H=async()=>{let e=D[0];console.log("Apply op",e);let[t,...n]=e,a=await le[t]?.(...n);if(ae.push(a),D.shift(),D.length)return H();let r=i.map(o=>j(o).replaceAll("\u0100"," ")),s=i.reduce((o,{duration:c})=>o+c,0),l=await Z(...i),h=new Blob([l],{type:"audio/wav"}),u=URL.createObjectURL(h);W++,self.postMessage({id:W,url:u,segments:r,duration:s})},i=[],le={async src(...e){return i=await Promise.all(e.map(V)),()=>i=[]},norm(){let e=i.map(l=>N(l)),t=0,n=0;for(let l of i)for(let h=0;h<l.numberOfChannels;h++){let u=l.getChannelData(h);n+=u.length;for(let o=0;o<u.length;o++)t+=u[o]}let a=t/n;for(let l of i)for(let h=0;h<l.numberOfChannels;h++){let u=l.getChannelData(h);n+=u.length;for(let o=0;o<u.length;o++)u[o]-=a}let r=0;for(let l of i)for(let h=0;h<l.numberOfChannels;h++){let u=l.getChannelData(h);for(let o=0;o<u.length;o++)r=Math.max(Math.abs(u[o]),r)}let s=Math.max(1/r,1);for(let l of i)for(let h=0;h<l.numberOfChannels;h++){let u=l.getChannelData(h);for(let o=0;o<u.length;o++)u[o]=Math.min(1,Math.max(-1,u[o]*s))}return()=>e},br(e,...t){for(let n of t){let[a,r]=O(n),s=e[a];if(r>0&&r<s.length){let l=sliceAudio(s,0,r),h=sliceAudio(s,r);e.splice(a,1,l,h)}}return e},join(e){let[t,n]=O(e);if(n)return console.warn("Wrong buffer offset",e);let a=i[t-1],r=i[t];return i.splice(t-1,2,joinAudio(a,r)),i},del(e,t){if(e=Number(e),t=Number(t),!t)return i;let n=O(e),a=O(e+t);!a[1]&&a[0]&&(a[0]-=1,a[1]=i[a[0]].length);let r=i[n[0]],s=i[a[0]],l=new m({length:n[1]+(s.length-a[1]),sampleRate:r.sampleRate,numberOfChannels:r.numberOfChannels});for(let u=0;u<r.numberOfChannels;u++){let o=0,c=l.getChannelData(u),p=r.getChannelData(u),A=s.getChannelData(u);for(o=0;o<n[1];o++)c[o]=p[o];for(let f=a[1];f<A.length;f++)c[o]=A[f],o++}let h=i.splice(n[0],a[0]-n[0]+1,l);return()=>{}},mute(...e){for(let t of e){let[n,a]=t,[r,s]=O(n);!s&&r&&(r-=1,s=i[r].length);let l=new m({length:a*1024,numberOfChannels:i?.[0].numberOfChannels||1,sampleRate:i?.[0].sampleRate||44100});i[r]=insertAudio(i[r],s,l)}return i},clip(e,t){},add(e,t){},cp(e,t,n){},undo(){}},O=e=>{let t=e*1024;if(t===0)return[0,0];var n=0,a;for(let r=0;r<i.length;r++){if(a=n+i[r].length,t<a)return[r,t-n];n=a}return[i.length-1,i[i.length-1].length]};
//# sourceMappingURL=worker.js.map
