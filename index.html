<!DOCTYPE html>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Wavearea</title>

<link href="./main.css" rel="stylesheet"/>

<body>
  <div class="wavearea"
    :onpopstate.window="e => goto(e.state)"
    :onmousedown.document..onmouseup.document="e=> (isMouseDown = true, e=> isMouseDown = false)"
    :onkeydown.document..onkeyup.document="(e) => (isKeyDown++, e=> (e.stopImmediatePropagation(), isKeyDown--))"
    >
    <div class="w-container"
      :onkeydown.arrow="e=>requestAnimationFrame(handleCaret)"
      :onselectstart..onselectionchange.document.once="e => handleCaret"
      :onselectionchange.document="e => (!playing && handleCaret(e))">
      <div class="w-waveform wavefont">
        <button class="w-play"
          :title="loading ? loading : `${playing ? 'Pause' : 'Play'} (Space)`"
          :class="{'w-loading':loading}"
          :disabled="loading"
          :hidden="!segments.length"
          :onclick.toggle="play"
          :onkeydown.document.space="e=>this.click(e)"
          :style="{
            '--carety': caretLine,
            position: !caretOffscreen ? 'absolute' : 'fixed',
            ...(!caretOffscreen ? {} : caretOffscreen > 0 ? {top:0} : {bottom:0,top:'auto'})
          }">
          <span class="w-play-clickarea"></span>
          <svg :hidden="playing" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M8 5v14l11-7L8 5z"/></svg>
          <svg :hidden="!playing" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
        </button>
        <span class="w-caret-line" :style="{'--carety': caretLine}"></span>
        <div class="w-loader"
          :if="loading"
          :with="{str:''}"
          :="clearInterval(this._id), loading ? (this._id = setInterval(()=>(str+='.'), 50)) : str = ''"
          :text="str"
        >...</div>
        <div class="w-opener" :if="!segments.length && !loading">
          <input id="w-file" class="w-file" type="file" accept="audio/*, video/*" :onchange="handleFile"/>
          <label for="w-file" title="Open file">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" height="24px" width="24px" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m6-6H6" />
            </svg>
          </label>
          <!-- <button class="w-record">
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><path d="M0 0h24v24H0V0z" fill="none"/><circle cx="12" cy="12" r="8"/></svg>
            Record
          </button> -->
          <!-- Recent -->
        </div>
        <div class="w-timecodes"><p :each="segment, id1 in segments" :key="id1" :text="
          let lines = Math.ceil(segment.length / lineWidth) || 0;
          let offset = Number(this.previousSibling?.dataset?.length || 0);
          return Array.from({length: lines || 1}, (_,i) => timecode(i * (lineWidth||0) + offset)).join('\n')
        " :data="{length: segment.length}"></p></div>
        <div class="w-status" :if="!segments.length" :text="loading || 'Add audio'"></div>
        <div contenteditable :ref="editarea" class="w-editable wavefont"
          :oninput="e=>(updateTimecodes(e),handleCaret(e))"
          :onbeforeinput="handleBeforeInput"
          :ondblclick.prevent
          :ondragenter..ondragleave:ondragenter..ondrop="e=>(this.classList.add('w-dragover'),e=>this.classList.remove('w-dragover'))"
          :ondrop="e=>console.log(e.dataTransfer.types)||e.preventDefault()"
          :style="{'--linew': lineWidth||10}"
        ><p class="w-segment" :each="segment, id1 in (segments.length ? segments : [''])" :key="id1" :text="segment"></p></div>
        <div class="w-played wavefont" :text="
          loop ? (' '.repeat(loopStart) + editarea.textContent.slice(loopStart, playing ?  caretOffset : loopEnd)) :
          editarea.textContent.slice(0, caretOffset)
        "></div>
      </div>

      <div class="w-playback" :if="false">
        <button class="w-play"
          :title="loading ? loading : `${playing ? 'Pause' : 'Play'} (Space)`"
          :class="{'w-loading':loading}"
          :disabled="loading"
          :hidden="!segments.length"
          :onclick.toggle="play"
          :onkeydown.document.space="e=>this.click(e)">
          <span class="w-play-clickarea"></span>
          <svg :hidden="playing" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M8 5v14l11-7L8 5z"/></svg>
          <svg :hidden="!playing" xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000"><path d="M0 0h24v24H0V0z" fill="none"/><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
        </button>
        <span class="w-time" title="Current time" :text="timecode(caretOffset, 2)"></span>
        <span style="opacity: .25">/</span>
        <span class="w-time" title="Time until the end" :text="'‒' + timecode(total - caretOffset, 2)"></span>
      </div>
    </div>

    <!--
    <dialog class="w-info-dialog" id="info-dialog" :ref="info" :onclick="e => {
      if (e.offsetX < 0 || e.offsetX > e.target.offsetWidth || e.offsetY < 0 || e.offsetY > e.target.offsetHeight) {
        info.close();
      }
    }">
      <h3 align="center" style="margin-bottom:.4rem">Wavearea</h3>
      <p align="center"><a href="https://github.com/dy/wavearea">Github</a></p>
      <p align="center"><a href="https://krishnized.github.io/license/">ॐ</a></p>
    </dialog>
    <button class="w-info-button" id="show-info-dialog" :onclick="e => info.showModal();">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="32" height="32">
        <path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12m-9-3.75h.008v.008H12V8.25z" />
      </svg>
    </button>
    -->
    <a class="w-krsnzd" href="https://krishnized.github.io/license/">ॐ</a>
  </div>


  <script type="module" src="./dist/wavearea.js"></script>
</body>

